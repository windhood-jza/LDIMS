openapi: 3.0.3
info:
  title: LDIMS æ–‡æ¡£æ–‡ä»¶å†…å®¹æå– API
  description: |
    LDIMSç³»ç»Ÿä¸­æ–‡æ¡£æ–‡ä»¶å†…å®¹æå–APIï¼Œå…è®¸å®¢æˆ·ç«¯è·å–å·²ä¸Šä¼ æ–‡æ¡£æ–‡ä»¶çš„å…ƒæ•°æ®å’Œæå–çš„æ–‡æœ¬å†…å®¹ã€‚

    ## åŠŸèƒ½ç‰¹æ€§
    - ğŸ” JWTè®¤è¯ä¿æŠ¤
    - ğŸ“„ æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼çš„å†…å®¹æå–
    - ğŸš€ é«˜æ€§èƒ½å“åº” (P95 < 500ms)
    - ğŸ›¡ï¸ å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
    - ğŸ“Š è¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—

  version: 1.0.0
  contact:
    name: LDIMS å¼€å‘å›¢é˜Ÿ
    email: dev@ldims.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:5000/api/documents
    description: æœ¬åœ°å¼€å‘ç¯å¢ƒ
  - url: https://api.ldims.com/api/documents
    description: ç”Ÿäº§ç¯å¢ƒ

paths:
  /files/{file_id}/content:
    get:
      tags:
        - DocumentFiles
      summary: è·å–æ–‡æ¡£æ–‡ä»¶æå–å†…å®¹
      description: |
        æ ¹æ®æ–‡ä»¶IDè·å–æ–‡æ¡£æ–‡ä»¶çš„å…ƒæ•°æ®å’Œæå–çš„æ–‡æœ¬å†…å®¹ã€‚

        ## æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
        - PDF (.pdf)
        - Microsoft Word (.doc, .docx)
        - æ–‡æœ¬æ–‡ä»¶ (.txt)
        - RTF (.rtf)

        ## æƒé™è¦æ±‚
        - ç”¨æˆ·å¿…é¡»å…·æœ‰æœ‰æ•ˆçš„JWT token
        - ç”¨æˆ·å¿…é¡»æœ‰æƒè®¿é—®æŒ‡å®šçš„æ–‡ä»¶

      operationId: getDocumentFileContent
      parameters:
        - name: file_id
          in: path
          required: true
          description: æ–‡æ¡£æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦
          schema:
            type: integer
            format: int64
            minimum: 1
            example: 123
        - name: includeMetadata
          in: query
          required: false
          description: æ˜¯å¦åŒ…å«æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯
          schema:
            type: boolean
            default: true
            example: true
        - name: format
          in: query
          required: false
          description: å“åº”æ ¼å¼ç±»å‹
          schema:
            type: string
            enum: [json, text]
            default: json
            example: json
      security:
        - bearerAuth: []
      responses:
        "200":
          description: æˆåŠŸè·å–æ–‡ä»¶å†…å®¹
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
              examples:
                completedFile:
                  summary: å¤„ç†å®Œæˆçš„æ–‡ä»¶
                  value:
                    success: true
                    code: 200
                    message: "è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ"
                    data:
                      fileId: 123
                      fileName: "æŠ€æœ¯æ–¹æ¡ˆ.pdf"
                      filePath: "documents/2024/01/tech-proposal.pdf"
                      extractedContent: "è¿™æ˜¯ä¸€ä»½æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£...\n\n## é¡¹ç›®èƒŒæ™¯\n\næœ¬é¡¹ç›®æ—¨åœ¨..."
                      processingStatus: "completed"
                      extractedAt: null
                      fileSize: 2048576
                      mimeType: "application/pdf"
                      documentId: 45
                      uploadedAt: "2024-01-15T08:30:00.000Z"
                processingFile:
                  summary: æ­£åœ¨å¤„ç†çš„æ–‡ä»¶
                  value:
                    success: true
                    code: 200
                    message: "è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ"
                    data:
                      fileId: 124
                      fileName: "åˆåŒæ–‡æ¡£.docx"
                      filePath: "documents/2024/01/contract.docx"
                      extractedContent: null
                      processingStatus: "processing"
                      extractedAt: null
                      fileSize: 1536000
                      mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                      documentId: 46
                      uploadedAt: "2024-01-15T09:15:00.000Z"
        "400":
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidFileId:
                  summary: æ— æ•ˆçš„æ–‡ä»¶ID
                  value:
                    success: false
                    code: 400
                    message: "å‚æ•°éªŒè¯å¤±è´¥"
                    data:
                      - msg: "æ— æ•ˆçš„æ–‡ä»¶ID"
                        param: "file_id"
                        location: "params"
        "401":
          description: æœªè®¤è¯ - ç¼ºå°‘æˆ–æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingToken:
                  summary: ç¼ºå°‘è®¤è¯ä»¤ç‰Œ
                  value:
                    success: false
                    code: 401
                    message: "æœªæä¾›æœ‰æ•ˆçš„è®¤è¯ä»¤ç‰Œ"
                invalidToken:
                  summary: æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ
                  value:
                    success: false
                    code: 401
                    message: "è®¤è¯ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"
        "403":
          description: ç¦æ­¢è®¿é—® - æ— æƒè®¿é—®æŒ‡å®šæ–‡ä»¶
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                accessDenied:
                  summary: æ— æƒè®¿é—®æ–‡ä»¶
                  value:
                    success: false
                    code: 403
                    message: "æ— æƒè®¿é—®è¯¥æ–‡ä»¶"
        "404":
          description: æ–‡ä»¶ä¸å­˜åœ¨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                fileNotFound:
                  summary: æ–‡ä»¶ä¸å­˜åœ¨
                  value:
                    success: false
                    code: 404
                    message: "æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤"
        "429":
          description: è¯·æ±‚è¿‡äºé¢‘ç¹
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                rateLimited:
                  summary: è¶…å‡ºè¯·æ±‚é™åˆ¶
                  value:
                    success: false
                    code: 429
                    message: "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"
        "500":
          description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                internalError:
                  summary: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
                  value:
                    success: false
                    code: 500
                    message: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWTè®¤è¯ä»¤ç‰Œã€‚æ ¼å¼ï¼šBearer <token>

        ## è·å–Token
        é€šè¿‡ç”¨æˆ·ç™»å½•æ¥å£è·å–JWT token

        ## Tokenæ ¼å¼
        ```
        Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        ```

  schemas:
    SuccessResponse:
      type: object
      required:
        - success
        - code
        - message
        - data
      properties:
        success:
          type: boolean
          example: true
          description: è¯·æ±‚æ˜¯å¦æˆåŠŸ
        code:
          type: integer
          example: 200
          description: HTTPçŠ¶æ€ç 
        message:
          type: string
          example: "è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ"
          description: å“åº”æ¶ˆæ¯
        data:
          $ref: "#/components/schemas/DocumentFileContentResponse"
          description: æ–‡ä»¶å†…å®¹æ•°æ®

    ErrorResponse:
      type: object
      required:
        - success
        - code
        - message
      properties:
        success:
          type: boolean
          example: false
          description: è¯·æ±‚æ˜¯å¦æˆåŠŸ
        code:
          type: integer
          example: 400
          description: HTTPçŠ¶æ€ç 
        message:
          type: string
          example: "å‚æ•°éªŒè¯å¤±è´¥"
          description: é”™è¯¯æ¶ˆæ¯
        data:
          type: array
          items:
            $ref: "#/components/schemas/ValidationError"
          description: è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

    DocumentFileContentResponse:
      type: object
      required:
        - fileId
        - fileName
        - filePath
        - processingStatus
        - fileSize
        - mimeType
        - documentId
        - uploadedAt
      properties:
        fileId:
          type: integer
          format: int64
          example: 123
          description: æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦
        fileName:
          type: string
          example: "æŠ€æœ¯æ–¹æ¡ˆ.pdf"
          description: åŸå§‹æ–‡ä»¶å
        filePath:
          type: string
          example: "documents/2024/01/tech-proposal.pdf"
          description: æ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šçš„å­˜å‚¨è·¯å¾„
        extractedContent:
          type: string
          nullable: true
          example: "è¿™æ˜¯ä¸€ä»½æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£...\n\n## é¡¹ç›®èƒŒæ™¯\n\næœ¬é¡¹ç›®æ—¨åœ¨..."
          description: ä»æ–‡ä»¶ä¸­æå–çš„æ–‡æœ¬å†…å®¹ï¼Œå¦‚æœæ–‡ä»¶å°šæœªå¤„ç†å®Œæˆåˆ™ä¸ºnull
        processingStatus:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
            - ocr_fallback
          example: "completed"
          description: |
            æ–‡ä»¶å¤„ç†çŠ¶æ€ï¼š
            - pending: ç­‰å¾…å¤„ç†
            - processing: æ­£åœ¨å¤„ç†
            - completed: å¤„ç†å®Œæˆ
            - failed: å¤„ç†å¤±è´¥
            - ocr_fallback: OCRå¤‡ç”¨å¤„ç†
        extractedAt:
          type: string
          format: date-time
          nullable: true
          example: null
          description: å†…å®¹æå–å®Œæˆæ—¶é—´ (ISO 8601æ ¼å¼)
        fileSize:
          type: integer
          format: int64
          example: 2048576
          description: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        mimeType:
          type: string
          example: "application/pdf"
          description: æ–‡ä»¶MIMEç±»å‹
        documentId:
          type: integer
          format: int64
          example: 45
          description: å…³è”çš„æ–‡æ¡£ID
        uploadedAt:
          type: string
          format: date-time
          example: "2024-01-15T08:30:00.000Z"
          description: æ–‡ä»¶ä¸Šä¼ æ—¶é—´ (ISO 8601æ ¼å¼)

    ValidationError:
      type: object
      required:
        - msg
        - param
        - location
      properties:
        msg:
          type: string
          example: "æ— æ•ˆçš„æ–‡ä»¶ID"
          description: éªŒè¯é”™è¯¯æ¶ˆæ¯
        param:
          type: string
          example: "file_id"
          description: å‡ºé”™çš„å‚æ•°å
        location:
          type: string
          example: "params"
          description: å‚æ•°ä½ç½®ï¼ˆparams, query, bodyç­‰ï¼‰

  examples:
    CompletedFileResponse:
      summary: å¤„ç†å®Œæˆçš„æ–‡ä»¶å“åº”
      value:
        success: true
        code: 200
        message: "è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ"
        data:
          fileId: 123
          fileName: "æŠ€æœ¯æ–¹æ¡ˆ.pdf"
          filePath: "documents/2024/01/tech-proposal.pdf"
          extractedContent: "è¿™æ˜¯ä¸€ä»½æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£çš„è¯¦ç»†å†…å®¹..."
          processingStatus: "completed"
          extractedAt: null
          fileSize: 2048576
          mimeType: "application/pdf"
          documentId: 45
          uploadedAt: "2024-01-15T08:30:00.000Z"

    ProcessingFileResponse:
      summary: æ­£åœ¨å¤„ç†çš„æ–‡ä»¶å“åº”
      value:
        success: true
        code: 200
        message: "è·å–æ–‡ä»¶å†…å®¹æˆåŠŸ"
        data:
          fileId: 124
          fileName: "åˆåŒæ–‡æ¡£.docx"
          filePath: "documents/2024/01/contract.docx"
          extractedContent: null
          processingStatus: "processing"
          extractedAt: null
          fileSize: 1536000
          mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          documentId: 46
          uploadedAt: "2024-01-15T09:15:00.000Z"

tags:
  - name: DocumentFiles
    description: |
      æ–‡æ¡£æ–‡ä»¶ç›¸å…³æ“ä½œï¼ŒåŒ…æ‹¬æ–‡ä»¶å†…å®¹æå–ã€å…ƒæ•°æ®è·å–ç­‰åŠŸèƒ½ã€‚

      ## ä¸»è¦åŠŸèƒ½
      - ğŸ“„ è·å–æ–‡æ¡£æ–‡ä»¶çš„æå–å†…å®¹
      - ğŸ“Š æŸ¥çœ‹æ–‡ä»¶å¤„ç†çŠ¶æ€
      - ğŸ” è·å–æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯

      ## ä½¿ç”¨æ³¨æ„äº‹é¡¹
      - æ‰€æœ‰æ¥å£éƒ½éœ€è¦JWTè®¤è¯
      - è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼šæ¯åˆ†é’Ÿ100æ¬¡
      - æ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¤§å°ï¼š50MB
