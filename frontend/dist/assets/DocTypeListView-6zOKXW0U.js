import{d as ue,r as f,l as E,m as j,o as ce,p as A,g as r,h as P,E as v,n as K,i as F,f as t,u as l,ak as G,b as pe,c as fe,al as me,j as y,t as ve,z as b,a4 as H,ae as Q,k as h,ai as W,e as ye,v as X,a5 as k,y as D,A as ge,am as Y,P as Te,an as be,ao as he,q as ke,J as we,_ as Ve}from"./index-CltJVasi.js";import{g as _e,u as Ie,c as De,d as Ce}from"./doctype-BLonRZzy.js";const xe={class:"clearfix"},Oe={class:"custom-tree-node"},Ee={class:"clearfix"},Fe={style:{float:"right"}},Re={key:0,class:"form-content"},Be={class:"dialog-footer"},Se=ue({__name:"DocTypeListView",setup(Ue){console.log("DocTypeManagement script setup executing...");const q=f(),I=f(),C=f(),w=f([]),g=f(!1),o=f(null),n=E({id:void 0,name:"",parentId:null,sortOrder:0,description:""}),V=f(!1),R=f(!1),B=f("addTopLevel"),S=f(null),U=f("无 (作为顶级类型)"),u=E({name:"",parentId:null,sortOrder:0,description:""}),Z=j(()=>B.value==="addTopLevel"?"新增顶级文档类型":"新增子文档类型"),ee=j(()=>{const a=(s,i)=>{if(!s||i===void 0)return s;const O=p=>{let c=[];return p.forEach(T=>{c.push(T),T.children&&(c=c.concat(O(T.children)))}),c},$=O(w.value),d=(p,c)=>c===null?null:p.find(T=>T.id===c)||null;return s.map(p=>{let c=!1;p.id===i&&(c=!0);let T=!1,m=p;for(;(m==null?void 0:m.parentId)!==null&&(m==null?void 0:m.parentId)!==void 0;){if(m.parentId===i){T=!0;break}if(m=d($,m.parentId),!m)break}return T&&(c=!0),{...p,disabled:c,children:p.children?a(p.children,i):void 0}})},e=a(w.value,n.id);return[{id:null,name:"无 (作为顶级类型)",children:[],disabled:!1},...e]}),le=j(()=>n.id?n.parentId===n.id:!1),z={label:"name",children:"children",value:"id"},ae=E({name:[{required:!0,message:"请输入类型名称",trigger:"blur"}],sortOrder:[{type:"number",message:"排序号必须为数字"}]}),te=E({name:[{required:!0,message:"请输入类型名称",trigger:"blur"}],sortOrder:[{type:"number",message:"排序号必须为数字"}]}),x=async()=>{var a;console.log("fetchDocTypeTree started..."),g.value=!0;try{const e=await _e();console.log("fetchDocTypeTree data received:",e),w.value=e,((a=o.value)==null?void 0:a.id)!==void 0?N(o.value.id):(o.value=null,_())}catch(e){console.error("fetchDocTypeTree error:",e),v.error(e.message||"获取文档类型失败"),w.value=[],o.value=null,_()}finally{g.value=!1}},L=(a,e)=>{if(!a)return null;for(const s of a){if(s.id===e)return s;if(s.children){const i=L(s.children,e);if(i)return i}}return null},N=a=>{const e=L(w.value,a);e?(o.value={...e},Object.assign(n,{id:e.id,name:e.name,parentId:e.parentId,sortOrder:e.sort??0,description:e.description??""}),K(()=>{var s,i;(s=I.value)==null||s.clearValidate(),(i=q.value)==null||i.setCurrentKey(a)})):(o.value=null,_())},re=a=>{console.log("handleNodeClick called with data:",a),a.id!==void 0?N(a.id):(console.warn("Clicked node has no ID:",a),o.value=null,_())},_=()=>{o.value?Object.assign(n,{id:o.value.id,name:o.value.name,parentId:o.value.parentId,sortOrder:o.value.sort??0,description:o.value.description??""}):Object.assign(n,{id:void 0,name:"",parentId:null,sortOrder:0,description:""}),K(()=>{var a;(a=I.value)==null||a.clearValidate()})},oe=()=>{_()},ne=async()=>{if(!I.value||!o.value||n.id===void 0){console.warn("Form submit aborted. Ref or selection missing.");return}await I.value.validate(async a=>{if(a){g.value=!0;try{const e={name:n.name,parentId:n.parentId,sortOrder:n.sortOrder,description:n.description};await Ie(n.id,e),v.success("文档类型更新成功"),await x(),N(n.id)}catch(e){console.error("Update DocType Error:",e),v.error(e.message||"更新失败")}finally{g.value=!1}}else console.log("Form validation failed.")})},M=()=>{var a;Object.assign(u,{name:"",parentId:null,sortOrder:0,description:""}),(a=C.value)==null||a.resetFields()},de=()=>{M(),B.value="addTopLevel",S.value=null,U.value="无 (作为顶级类型)",u.parentId=null,V.value=!0},se=a=>{M(),B.value="addChild",S.value=a.id??null,U.value=a.name,u.parentId=a.id??null,V.value=!0},ie=async()=>{C.value&&await C.value.validate(async a=>{if(a){R.value=!0;try{const e={name:u.name,parentId:S.value,sortOrder:u.sortOrder,description:u.description};await De(e),v.success("文档类型创建成功"),V.value=!1,await x()}catch(e){console.error("Create DocType Error:",e),v.error(e.message||"创建失败")}finally{R.value=!1}}})},J=async(a,e)=>{if(!e||e.id===void 0){v.warning("无法删除，节点数据无效。");return}const s=L(w.value,e.id);if(s&&s.children&&s.children.length>0){v.warning("该类型下有子类型，请先删除子类型。");return}try{await we.confirm(`确定要删除文档类型 "${e.name}" 吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),g.value=!0,await Ce(e.id),v.success(`文档类型 "${e.name}" 删除成功`),o.value&&o.value.id===e.id&&(o.value=null,_()),await x()}catch(i){i!=="cancel"&&(console.error("Delete DocType Error:",i),v.error(i.message||"删除失败"))}finally{g.value=!1}};return ce(()=>{x()}),(a,e)=>{const s=P("el-aside"),i=P("el-main"),O=P("el-container"),$=fe("loading");return F(),A(O,{class:"doctype-management-page"},{default:r(()=>[t(s,{width:"547px",class:"tree-aside"},{default:r(()=>[t(l(G),{class:"tree-card",shadow:"never"},{header:r(()=>[y("div",xe,[e[11]||(e[11]=y("span",null,"文档类型",-1)),t(l(b),{type:"primary",icon:l(Q),style:{float:"right"},onClick:de},{default:r(()=>e[10]||(e[10]=[h("新增顶级")])),_:1},8,["icon"])])]),default:r(()=>[pe((F(),A(l(me),{ref_key:"docTypeTreeRef",ref:q,data:w.value,props:z,"node-key":"id","highlight-current":"","default-expand-all":"","expand-on-click-node":!1,onNodeClick:re,class:"full-height-tree"},{default:r(({node:d,data:p})=>[y("span",Oe,[y("span",null,ve(d.label),1),y("span",null,[t(l(b),{type:"primary",link:"",icon:l(Q),onClick:H(c=>se(p),["stop"])},{default:r(()=>e[12]||(e[12]=[h("新增子级")])),_:2},1032,["icon","onClick"]),t(l(b),{type:"danger",link:"",icon:l(W),onClick:H(c=>J(d,p),["stop"])},{default:r(()=>e[13]||(e[13]=[h("删除")])),_:2},1032,["icon","onClick"])])])]),_:1},8,["data"])),[[$,g.value]])]),_:1})]),_:1}),t(i,{class:"form-main"},{default:r(()=>[t(l(G),{class:"form-card",shadow:"never"},{header:r(()=>[y("div",Ee,[e[17]||(e[17]=y("span",null,"文档类型信息",-1)),y("div",Fe,[t(l(b),{icon:l(be),onClick:oe,disabled:!o.value},{default:r(()=>e[14]||(e[14]=[h(" 重置 ")])),_:1},8,["icon","disabled"]),t(l(b),{type:"danger",icon:l(W),onClick:e[0]||(e[0]=d=>J(null,o.value)),disabled:!o.value||!o.value.id,style:{"margin-left":"10px"}},{default:r(()=>e[15]||(e[15]=[h(" 删除 ")])),_:1},8,["icon","disabled"]),t(l(b),{type:"primary",icon:l(he),onClick:ne,loading:g.value,disabled:!o.value||!o.value.id,style:{"margin-left":"10px"}},{default:r(()=>e[16]||(e[16]=[h(" 保存 ")])),_:1},8,["icon","loading","disabled"])])])]),default:r(()=>[o.value?(F(),ye("div",Re,[t(l(X),{ref_key:"docTypeFormRef",ref:I,model:n,rules:ae,"label-width":"100px"},{default:r(()=>[t(l(k),{label:"类型名称",prop:"name"},{default:r(()=>[t(l(D),{modelValue:n.name,"onUpdate:modelValue":e[1]||(e[1]=d=>n.name=d),placeholder:"请输入类型名称"},null,8,["modelValue"])]),_:1}),t(l(k),{label:"上级类型",prop:"parentId"},{default:r(()=>[t(l(ge),{modelValue:n.parentId,"onUpdate:modelValue":e[2]||(e[2]=d=>n.parentId=d),data:ee.value,props:z,"node-key":"id",placeholder:"选择上级类型 (不选则为顶级)",clearable:"",filterable:"","check-strictly":"","render-after-expand":!1,style:{width:"100%"},disabled:le.value},null,8,["modelValue","data","disabled"])]),_:1}),t(l(k),{label:"排序号",prop:"sortOrder"},{default:r(()=>[t(l(Y),{modelValue:n.sortOrder,"onUpdate:modelValue":e[3]||(e[3]=d=>n.sortOrder=d),min:0,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(l(k),{label:"描述",prop:"description"},{default:r(()=>[t(l(D),{type:"textarea",modelValue:n.description,"onUpdate:modelValue":e[4]||(e[4]=d=>n.description=d),rows:4,placeholder:"请输入描述信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])):(F(),A(l(Te),{key:1,description:"请在左侧选择一个文档类型进行查看或编辑"}))]),_:1})]),_:1}),t(l(ke),{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=d=>V.value=d),title:Z.value,width:"500px",onClosed:M},{footer:r(()=>[y("span",Be,[t(l(b),{onClick:e[8]||(e[8]=d=>V.value=!1)},{default:r(()=>e[18]||(e[18]=[h("取消")])),_:1}),t(l(b),{type:"primary",onClick:ie,loading:R.value},{default:r(()=>e[19]||(e[19]=[h("确定")])),_:1},8,["loading"])])]),default:r(()=>[t(l(X),{ref_key:"dialogFormRef",ref:C,model:u,rules:te,"label-width":"100px"},{default:r(()=>[t(l(k),{label:"类型名称",prop:"name"},{default:r(()=>[t(l(D),{modelValue:u.name,"onUpdate:modelValue":e[5]||(e[5]=d=>u.name=d),placeholder:"请输入类型名称"},null,8,["modelValue"])]),_:1}),t(l(k),{label:"上级类型"},{default:r(()=>[t(l(D),{value:U.value,disabled:""},null,8,["value"])]),_:1}),t(l(k),{label:"排序号",prop:"sortOrder"},{default:r(()=>[t(l(Y),{modelValue:u.sortOrder,"onUpdate:modelValue":e[6]||(e[6]=d=>u.sortOrder=d),min:0,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(l(k),{label:"描述",prop:"description"},{default:r(()=>[t(l(D),{type:"textarea",modelValue:u.description,"onUpdate:modelValue":e[7]||(e[7]=d=>u.description=d),rows:4,placeholder:"请输入描述信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])]),_:1})}}}),Me=Ve(Se,[["__scopeId","data-v-3d801958"]]);export{Me as default};
