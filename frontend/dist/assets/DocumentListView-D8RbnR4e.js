import{w as de,d as ue,r as f,l as ne,m as K,p as j,g as l,u as t,q as ge,n as _e,i as A,b as xe,c as Ie,s as fe,f as e,h as O,e as se,k as v,F as me,j as Y,v as Ve,t as X,E as g,_ as ie,x as pe,y as De,z as re,A as ye,B as be,C as ee,D as Ne,G as we,H as ke,I as Se,J as Te,K as Ce,o as Ee,L as Fe,M as Z,N as he,O as Ue,P as $e,Q as Re,R as Le,S as Pe,T as ze,U as Ae,V as Be,W as Me,X as qe}from"./index-DAb5ELNo.js";import{g as Je}from"./doctype-DCkeLsnD.js";import{r as Oe,a as Ye}from"./task-RJbnAqFC.js";const je=async B=>{console.log("[api/document.ts:getDocuments] Entry. Received params:",JSON.stringify(B,null,2));try{console.log("[api/document.ts:getDocuments] Params BEFORE passing to request util:",JSON.stringify(B,null,2));const L=await de.get("/documents",{params:B});return console.log("[api/document.ts] Response from wrappedRequest.get (should be PageResult):",L),L||{list:[],total:0}}catch(L){return console.error("[api/document.ts] Error in getDocuments:",L),{list:[],total:0}}},Qe=async B=>await de.post("/documents",B),Ge=async(B,L)=>await de.put(`/documents/${B}`,L),We=async B=>{await de.delete(`/documents/${B}`)},He={class:"dialog-footer"},Ke=ue({__name:"DocumentFormDialog",props:{docTypeTreeData:{},departmentTreeData:{}},emits:["success"],setup(B,{expose:L,emit:F}){const C=B,$=F,_=f(!1),E=f(!1),s=f(),y=f("add"),R=f(null),k=f(!1),x=f(!1),Q=()=>({doc_name:"",docTypeId:null,docTypeName:"",sourceDepartmentId:null,sourceDepartmentName:"",submitter:"",receiver:"",signer:null,storageLocation:null,handoverDate:null,remarks:""});let n=ne(Q());const N=K(()=>y.value==="view"),P=K(()=>y.value==="add"?"新增文档":y.value==="edit"?"编辑文档":"查看文档详情"),G={value:"id",label:"name",children:"children"},d=ne({doc_name:[{required:!0,message:"请输入文档名称",trigger:"blur"}],submitter:[{required:!0,message:"请输入提交人",trigger:"blur"}],receiver:[{required:!0,message:"请输入接收人",trigger:"blur"}],signer:[{max:50,message:"签章人名称过长",trigger:"blur"}],storageLocation:[{max:100,message:"存放位置过长",trigger:"blur"}],remarks:[{max:1e3,message:"备注过长",trigger:"blur"}]}),h=(o,a)=>{console.log("[Dialog] Open called with type:",o,"and data:",a),y.value=o,_.value=!0,E.value=!1,R.value=null,k.value=o==="add",x.value=o==="add";const m=c=>{if(c==null||c==="")return null;if(typeof c=="number")return c;const b=parseInt(c,10);return isNaN(b)?null:b};_e(()=>{var c,b,D;if((c=s.value)==null||c.resetFields(),Object.assign(n,Q()),console.log("[Dialog] FormData after reset:",JSON.parse(JSON.stringify(n))),(o==="edit"||o==="view")&&a){console.log("[Dialog] Populating form for edit/view. Data ID:",a.id),console.log("[Dialog] Data docTypeId:",a.docTypeId,typeof a.docTypeId),console.log("[Dialog] Data sourceDepartmentId:",a.sourceDepartmentId,typeof a.sourceDepartmentId),R.value=a.id??null,n.doc_name=a.doc_name??"",n.submitter=a.submitter??"",n.receiver=a.receiver??"",n.signer=a.signer??null,n.storageLocation=a.storageLocation??null,n.handoverDate=a.handoverDate??null,n.remarks=a.remarks??"";const J=m(a.docTypeId),W=m(a.sourceDepartmentId);n.docTypeId=J,n.sourceDepartmentId=W,n.docTypeName=a.docTypeName??null,n.sourceDepartmentName=a.departmentName??null,console.log("[Dialog] FormData after population:",JSON.parse(JSON.stringify(n)));const le=m(a.docTypeId),ae=m(a.sourceDepartmentId),w=(b=C.docTypeTreeData)==null?void 0:b.some(te=>U(te,le)),ce=(D=C.departmentTreeData)==null?void 0:D.some(te=>U(te,ae));console.log(`[Dialog] Node exists check in docTypeTreeData for ID ${a.docTypeId}?`,w),console.log(`[Dialog] Node exists check in departmentTreeData for ID ${a.sourceDepartmentId}?`,ce)}})},U=(o,a)=>!o||a===null||a===void 0?!1:o.id===a?!0:o.children&&o.children.length>0?o.children.some(m=>U(m,a)):!1,M=o=>{n.docTypeId=o;const a=(c,b)=>{if(!c||b===null)return null;for(const D of c){if(D.id===b)return D;if(D.children&&D.children.length>0){const J=a(D.children,b);if(J)return J}}return null},m=a(C.docTypeTreeData,o);n.docTypeName=m?m.name:null,console.log(`[Dialog] DocType changed. Selected ID: ${o}, Updated Name: ${n.docTypeName}`)},I=o=>{n.sourceDepartmentId=o;const a=(c,b)=>{if(!c||b===null)return null;for(const D of c){if(D.id===b)return D;if(D.children&&D.children.length>0){const J=a(D.children,b);if(J)return J}}return null},m=a(C.departmentTreeData,o);n.sourceDepartmentName=m?m.name:null,console.log(`[Dialog] Department changed. Selected ID: ${o}, Updated Name: ${n.sourceDepartmentName}`)},z=async()=>{if(!(N.value||!s.value))try{await s.value.validate(),E.value=!0;let o={docName:n.doc_name,submitter:n.submitter,receiver:n.receiver,signer:n.signer??void 0,storageLocation:n.storageLocation??void 0,handoverDate:n.handoverDate,remarks:n.remarks,docTypeId:n.docTypeId,sourceDepartmentId:n.sourceDepartmentId};console.log("[Dialog] Submitting data:",o),y.value==="add"?(await Qe(o),g.success("文档新增成功")):y.value==="edit"&&R.value&&(await Ge(R.value,o),g.success("文档更新成功")),_.value=!1,$("success")}catch(o){console.error("提交文档失败:",o),g.error(`操作失败: ${(o==null?void 0:o.message)||"请检查表单或联系管理员"}`)}finally{E.value=!1}},i=()=>{E.value||(_.value=!1)};return L({open:h}),(o,a)=>{const m=O("el-input"),c=O("el-form-item"),b=O("el-col"),D=O("el-button"),J=O("el-tree-select"),W=O("el-row"),le=O("el-date-picker"),ae=Ie("loading");return A(),j(t(ge),{modelValue:_.value,"onUpdate:modelValue":a[9]||(a[9]=w=>_.value=w),title:P.value,width:"60%","before-close":i,draggable:"","destroy-on-close":""},{footer:l(()=>[Y("span",He,[e(D,{onClick:i},{default:l(()=>[v(X(N.value?"关闭":"取消"),1)]),_:1}),N.value?Ve("",!0):(A(),j(D,{key:0,type:"primary",onClick:z,loading:E.value},{default:l(()=>a[12]||(a[12]=[v("确定")])),_:1},8,["loading"]))])]),default:l(()=>[xe((A(),j(t(fe),{ref_key:"formRef",ref:s,model:t(n),rules:N.value?{}:d,"label-width":"100px",disabled:N.value},{default:l(()=>[e(W,{gutter:20},{default:l(()=>[e(b,{span:12},{default:l(()=>[e(c,{label:"文档名称",prop:"doc_name"},{default:l(()=>[e(m,{modelValue:t(n).doc_name,"onUpdate:modelValue":a[0]||(a[0]=w=>t(n).doc_name=w),placeholder:"请输入文档名称",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(b,{span:12},{default:l(()=>[e(c,{label:"文档类型",prop:"docTypeName"},{default:l(()=>[N.value?(A(),j(m,{key:0,"model-value":t(n).docTypeName,disabled:"",placeholder:"---"},null,8,["model-value"])):k.value?(A(),j(J,{key:2,"model-value":t(n).docTypeId,"onUpdate:modelValue":M,placeholder:"请选择新文档类型",data:C.docTypeTreeData,props:G,"check-strictly":"","render-after-expand":!1,clearable:"",style:{width:"100%"}},null,8,["model-value","data"])):(A(),se(me,{key:1},[e(m,{"model-value":t(n).docTypeName,disabled:"",placeholder:"未指定",style:{width:"calc(100% - 70px)","margin-right":"8px"}},null,8,["model-value"]),e(D,{onClick:a[1]||(a[1]=w=>k.value=!0),disabled:N.value},{default:l(()=>a[10]||(a[10]=[v("更改")])),_:1},8,["disabled"])],64))]),_:1})]),_:1})]),_:1}),e(W,{gutter:20},{default:l(()=>[e(b,{span:12},{default:l(()=>[e(c,{label:"来源部门",prop:"sourceDepartmentName"},{default:l(()=>[N.value?(A(),j(m,{key:0,"model-value":t(n).sourceDepartmentName,disabled:"",placeholder:"---"},null,8,["model-value"])):x.value?(A(),j(J,{key:2,"model-value":t(n).sourceDepartmentId,"onUpdate:modelValue":I,placeholder:"请选择新来源部门",data:C.departmentTreeData,props:G,"check-strictly":"","render-after-expand":!1,clearable:"",style:{width:"100%"}},null,8,["model-value","data"])):(A(),se(me,{key:1},[e(m,{"model-value":t(n).sourceDepartmentName,disabled:"",placeholder:"未指定",style:{width:"calc(100% - 70px)","margin-right":"8px"}},null,8,["model-value"]),e(D,{onClick:a[2]||(a[2]=w=>x.value=!0),disabled:N.value},{default:l(()=>a[11]||(a[11]=[v("更改")])),_:1},8,["disabled"])],64))]),_:1})]),_:1}),e(b,{span:12},{default:l(()=>[e(c,{label:"交接日期",prop:"handoverDate"},{default:l(()=>[e(le,{modelValue:t(n).handoverDate,"onUpdate:modelValue":a[3]||(a[3]=w=>t(n).handoverDate=w),type:"date",placeholder:"选择交接日期","value-format":"YYYY-MM-DD",style:{width:"100%"},disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(W,{gutter:20},{default:l(()=>[e(b,{span:12},{default:l(()=>[e(c,{label:"提交人",prop:"submitter"},{default:l(()=>[e(m,{modelValue:t(n).submitter,"onUpdate:modelValue":a[4]||(a[4]=w=>t(n).submitter=w),placeholder:"请输入提交人",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(b,{span:12},{default:l(()=>[e(c,{label:"接收人",prop:"receiver"},{default:l(()=>[e(m,{modelValue:t(n).receiver,"onUpdate:modelValue":a[5]||(a[5]=w=>t(n).receiver=w),placeholder:"请输入接收人",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(W,{gutter:20},{default:l(()=>[e(b,{span:12},{default:l(()=>[e(c,{label:"签署人",prop:"signer"},{default:l(()=>[e(m,{modelValue:t(n).signer,"onUpdate:modelValue":a[6]||(a[6]=w=>t(n).signer=w),placeholder:"请输入签署人 (可选)",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(b,{span:12},{default:l(()=>[e(c,{label:"存放位置",prop:"storageLocation"},{default:l(()=>[e(m,{modelValue:t(n).storageLocation,"onUpdate:modelValue":a[7]||(a[7]=w=>t(n).storageLocation=w),placeholder:"请输入存放位置 (可选)",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(c,{label:"备注",prop:"remarks"},{default:l(()=>[e(m,{modelValue:t(n).remarks,"onUpdate:modelValue":a[8]||(a[8]=w=>t(n).remarks=w),type:"textarea",rows:"3",placeholder:"请输入备注信息 (可选)",disabled:N.value},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model","rules","disabled"])),[[ae,E.value]])]),_:1},8,["modelValue","title"])}}}),Xe=ie(Ke,[["__scopeId","data-v-618dcd59"]]),Ze={class:"dialog-footer"},el=ue({__name:"ExportOptionsDialog",emits:["export-started"],setup(B,{expose:L,emit:F}){const C=f([{label:"文档 ID",value:"id"},{label:"文档名称",value:"docName"},{label:"文档类型",value:"docTypeName"},{label:"来源部门",value:"sourceDepartmentName"},{label:"提交人",value:"submitter"},{label:"接收人",value:"receiver"},{label:"签收（章）人",value:"signer"},{label:"交接日期",value:"handoverDate"},{label:"保管位置",value:"storageLocation"},{label:"备注",value:"remarks"},{label:"创建人",value:"createdByName"},{label:"创建时间",value:"createdAt"},{label:"最后修改人",value:"updatedByName"},{label:"最后修改时间",value:"updatedAt"}]),$=f(!1),_=f(!1),E=f([]),s=f("xlsx"),y=f("all"),R=f(null),k=f([]),x=f([]),Q=F,n=K(()=>k.value.length>0),N=K(()=>k.value.length),P=K(()=>x.value.length>0),G=K(()=>x.value.length),d=(z,i=[],o=[])=>{console.log("[Debug] ExportOptionsDialog: Received selectedItemIds:",i),console.log("[Debug] ExportOptionsDialog: Received currentPageIds:",o),R.value=z,k.value=i,x.value=o,E.value=C.value.map(a=>a.value),i.length>0?y.value="selected":o.length>0?y.value="currentPage":y.value="all",$.value=!0},h=()=>{_.value||($.value=!1)},U=async()=>{var z,i;if(!E.value.length){g.warning("请至少选择一个要导出的字段");return}if(y.value==="selected"&&!n.value){g.warning("请先在表格中勾选要导出的文档");return}if(y.value==="currentPage"&&!P.value){g.warning("当前页没有可导出的数据");return}_.value=!0;try{const o={fields:E.value,fileType:s.value,exportScope:y.value};if(y.value==="all"&&R.value){const m=R.value,c={},b=["docName","submitter","receiver","docTypeId","sourceDepartmentId","docTypeNameFilter","sourceDepartmentNameFilter","signer"];for(const D of b)m[D]!==null&&m[D]!==void 0&&m[D]!==""&&(c[D]=m[D]);m.handoverDateRange&&Array.isArray(m.handoverDateRange)&&m.handoverDateRange.length===2&&(c.handoverDateStart=m.handoverDateRange[0],c.handoverDateEnd=m.handoverDateRange[1]),c.docTypeNameFilter===""&&delete c.docTypeNameFilter,c.sourceDepartmentNameFilter===""&&delete c.sourceDepartmentNameFilter,Object.keys(c).length>0&&(o.query=c)}else y.value==="selected"?o.selectedIds=k.value:y.value==="currentPage"&&(o.currentPageIds=x.value);console.log("[Debug] Export Request Params:",JSON.stringify(o));const a=await Oe(o);a&&typeof a.taskId=="number"?(console.log("[Debug] handleSubmit: Success path executing."),g.success('导出任务已创建，请稍后在"导出任务"页面查看进度和下载。'),Q("export-started",a.taskId),h()):(console.error("Invalid payload structure received after creating export task:",a),console.log("[Debug] handleSubmit: Invalid payload structure path executing."),g.error("创建导出任务失败：响应数据异常"))}catch(o){console.error("Request export error:",o);const a=((i=(z=o==null?void 0:o.response)==null?void 0:z.data)==null?void 0:i.message)||(o==null?void 0:o.message)||"创建导出任务时发生错误";console.log("[Debug] handleSubmit: Catch block executing."),g.error(a)}finally{_.value=!1}},M=()=>{E.value=C.value.map(z=>z.value)},I=()=>{E.value=[]};return L({open:d}),(z,i)=>(A(),j(t(ge),{modelValue:$.value,"onUpdate:modelValue":i[3]||(i[3]=o=>$.value=o),title:"导出选项",width:"650px","close-on-click-modal":!1,onClose:h},{footer:l(()=>[Y("span",Ze,[e(t(ee),{onClick:h},{default:l(()=>i[9]||(i[9]=[v("取消")])),_:1}),e(t(ee),{type:"primary",onClick:U,loading:_.value},{default:l(()=>i[10]||(i[10]=[v(" 确认导出 ")])),_:1},8,["loading"])])]),default:l(()=>[e(t(fe),{"label-width":"100px"},{default:l(()=>[e(t(pe),{label:"导出范围"},{default:l(()=>[e(t(De),{modelValue:y.value,"onUpdate:modelValue":i[0]||(i[0]=o=>y.value=o)},{default:l(()=>[e(t(re),{label:"all"},{default:l(()=>i[4]||(i[4]=[v("全部 (根据筛选条件)")])),_:1}),e(t(re),{label:"currentPage",disabled:!P.value},{default:l(()=>[v(" 当前页 ("+X(G.value)+" 项) ",1)]),_:1},8,["disabled"]),e(t(re),{label:"selected",disabled:!n.value},{default:l(()=>[v(" 选中项 ("+X(N.value)+" 项) ",1)]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),e(t(pe),{label:"选择字段"},{default:l(()=>[e(t(ye),{gutter:10,style:{width:"100%","margin-bottom":"10px"}},{default:l(()=>[e(t(be),{span:12},{default:l(()=>[e(t(ee),{type:"primary",link:"",onClick:M},{default:l(()=>i[5]||(i[5]=[v("全选")])),_:1}),e(t(ee),{type:"primary",link:"",onClick:I,style:{"margin-left":"15px"}},{default:l(()=>i[6]||(i[6]=[v("取消全选")])),_:1})]),_:1})]),_:1}),e(t(Ne),{modelValue:E.value,"onUpdate:modelValue":i[1]||(i[1]=o=>E.value=o)},{default:l(()=>[e(t(ye),{gutter:5,style:{width:"100%"}},{default:l(()=>[(A(!0),se(me,null,we(C.value,o=>(A(),j(t(be),{span:8,key:o.value},{default:l(()=>[e(t(ke),{label:o.value,style:{"margin-bottom":"8px"}},{default:l(()=>[v(X(o.label),1)]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(t(pe),{label:"文件类型"},{default:l(()=>[e(t(De),{modelValue:s.value,"onUpdate:modelValue":i[2]||(i[2]=o=>s.value=o)},{default:l(()=>[e(t(re),{label:"xlsx"},{default:l(()=>i[7]||(i[7]=[v("Excel (.xlsx)")])),_:1}),e(t(re),{label:"csv"},{default:l(()=>i[8]||(i[8]=[v("CSV (.csv)")])),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),ll=ie(el,[["__scopeId","data-v-8a0226dc"]]),al={class:"import-dialog-content"},tl={class:"dialog-footer"},ol=ue({__name:"ImportDialog",setup(B,{expose:L}){const F=f(!1),C=f(null),$=f(null),_=f(!1),s="http://localhost:3000/api/v1/upload/excel",y=K(()=>{const d=localStorage.getItem("authToken");return console.log("[ImportDialog] Token from localStorage:",d?"found":"not found"),d?{Authorization:`Bearer ${d}`}:{}}),R=async()=>{console.log("[ImportDialog] open method called."),console.log("[ImportDialog] Current dialogVisible state before change:",F.value);try{x(),F.value=!0,console.log("[ImportDialog] dialogVisible set to true. Waiting for nextTick..."),await _e(),console.log("[ImportDialog] After nextTick. Dialog should now be visible in the DOM."),console.log("[ImportDialog] Final dialogVisible state:",F.value)}catch(d){console.error("[ImportDialog] Error occurred within the open method:",d)}},k=()=>{if(_.value){g.warning("文件正在上传中，请稍候...");return}x(),F.value=!1},x=()=>{var d;$.value=null,(d=C.value)==null||d.clearFiles(),_.value=!1},Q=(d,h)=>{var U;console.log("[ImportDialog File Change] File status:",d.name,d.status),h.length>0?($.value=h[h.length-1],d.status==="fail"&&($.value=null,(U=C.value)==null||U.clearFiles())):$.value=null},n=d=>{console.log("[ImportDialog Before Upload] File:",d.name);const h=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],U=50,M=U*1024*1024,I=h.includes(d.type)||d.name.endsWith(".xls")||d.name.endsWith(".xlsx"),z=d.size<=M;return I?z?!0:(g.error(`文件大小不能超过 ${U}MB!`),!1):(g.error("文件类型错误，请上传 Excel 文件 (.xls, .xlsx)"),!1)},N=()=>{var d;if(!$.value){g.warning("请先选择一个 Excel 文件");return}_.value||(console.log("[ImportDialog Manual Upload] Triggering submit..."),_.value=!0,(d=C.value)==null||d.submit())},P=(d,h,U)=>{if(console.log("[ImportDialog Upload Success] Response:",d),_.value=!1,d&&d.code===201&&d.data){g.success(d.message||"文件上传成功，导入任务已创建"),k();return}if(d&&typeof d.fileName=="string"&&typeof d.originalName=="string"){g.info("文件上传成功，正在请求后台处理导入任务...");const M={fileName:d.fileName,originalName:d.originalName};Ye(M).then(I=>{(I==null?void 0:I.code)===200?(g.success("后台导入任务已创建！"),k()):g.error((I==null?void 0:I.message)||"触发导入任务失败")}).catch(I=>{var i,o;console.error("[ImportDialog Request Import] API Call Failed:",I);const z=((o=(i=I.response)==null?void 0:i.data)==null?void 0:o.message)||I.message||"请求触发导入任务时出错";g.error(`触发导入任务失败: ${z}`)})}else console.error("[ImportDialog Upload Success] Invalid upload response:",d),g.error((d==null?void 0:d.message)||"文件上传接口响应异常")},G=(d,h,U)=>{console.error("[ImportDialog Upload Error] Raw Error:",d),_.value=!1;let M="文件上传失败";try{if(d.response&&d.response.data)M=d.response.data.message||`上传失败，状态码：${d.response.status}`;else if(d.message)try{const I=JSON.parse(d.message);M=I.message?`文件上传失败: ${I.message}`:`文件上传失败: ${d.message}`}catch{M=`文件上传失败: ${d.message}`}}catch(I){console.error("[ImportDialog Upload Error] Parse error failed:",I)}g.error(M)};return L({open:R}),(d,h)=>(A(),j(t(ge),{modelValue:F.value,"onUpdate:modelValue":h[0]||(h[0]=U=>F.value=U),title:"批量导入文档",width:"600px",modal:!0,"append-to-body":!0,onClose:k,"close-on-click-modal":!_.value,"close-on-press-escape":!_.value,onClosed:x},{footer:l(()=>[Y("span",tl,[e(t(ee),{onClick:k,disabled:_.value},{default:l(()=>h[3]||(h[3]=[v("取消")])),_:1},8,["disabled"]),e(t(ee),{type:"primary",onClick:N,loading:_.value},{default:l(()=>[v(X(_.value?"上传中...":"确定上传并导入"),1)]),_:1},8,["loading"])])]),default:l(()=>[Y("div",al,[e(t(Ce),{ref_key:"uploadRef",ref:C,class:"upload-importer",drag:"",action:s,headers:y.value,limit:1,"auto-upload":!1,"on-change":Q,"before-upload":n,"on-success":P,"on-error":G,accept:".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"},{tip:l(()=>h[1]||(h[1]=[Y("div",{class:"el-upload__tip"},[v(" 请上传 .xls 或 .xlsx 格式的 Excel 文件，大小不超过 50MB。"),Y("br"),v(" 文件需要包含以下列：文档名称, 提交人, 接收人, [可选列: 文档类型, 来源部门, 签收人, 交接日期, 存放位置, 备注] ")],-1)])),default:l(()=>[e(t(Se),{class:"el-icon--upload"},{default:l(()=>[e(t(Te))]),_:1}),h[2]||(h[2]=Y("div",{class:"el-upload__text"},[v(" 将 Excel 文件拖到此处，或"),Y("em",null,"点击选择")],-1))]),_:1},8,["headers"])])]),_:1},8,["modelValue","close-on-click-modal","close-on-press-escape"]))}}),rl=ie(ol,[["__scopeId","data-v-1cbb28d7"]]),nl={class:"document-list-view"},sl={class:"filter-group"},dl={class:"filter-group"},ul={class:"toolbar"},il={class:"toolbar-buttons"},cl=ue({__name:"DocumentListView",setup(B){const L=f(),F=f(null),C=f(null),$=f(null),_=f(),E=f([]),s=ne({docName:"",submitter:"",receiver:"",docTypeId:null,sourceDepartmentId:null,docTypeNameFilter:"",sourceDepartmentNameFilter:"",signer:"",handoverDateRange:null,page:1,pageSize:10}),y=f([]),R=f(!1),k=f(!1),x=ne({page:1,pageSize:10,total:0}),Q=f([]),n=f([]),N={value:"id",label:"name",children:"children"},P=async u=>{var r,T,H,q;R.value=!0;try{const S={page:x.page,pageSize:x.pageSize,docName:s.docName||void 0,submitter:s.submitter||void 0,receiver:s.receiver||void 0,docTypeId:s.docTypeId??void 0,docTypeNameFilter:s.docTypeId?void 0:s.docTypeNameFilter||void 0,sourceDepartmentId:s.sourceDepartmentId??void 0,sourceDepartmentNameFilter:s.sourceDepartmentId?void 0:s.sourceDepartmentNameFilter||void 0,signer:s.signer||void 0,handoverDateStart:((r=s.handoverDateRange)==null?void 0:r[0])||void 0,handoverDateEnd:((T=s.handoverDateRange)==null?void 0:T[1])||void 0,sortField:u==null?void 0:u.prop,sortOrder:(u==null?void 0:u.order)==="descending"?"DESC":(u==null?void 0:u.order)==="ascending"?"ASC":void 0};Object.keys(S).forEach(oe=>{const p=oe;(S[p]===void 0||S[p]===null||S[p]==="")&&delete S[p]});const V=await je(S);console.log("[DocumentListView] Raw response from getDocuments service:",V),V&&Array.isArray(V.list)&&typeof V.total=="number"?(console.log("[DocumentListView] Trying to extract from result directly"),y.value=V.list,x.total=V.total):(console.error("Invalid data structure received from getDocuments:",V),g.error("获取文档列表失败：数据格式错误"),y.value=[],x.total=0)}catch(S){console.error("Fetch documents error:",S);const V=((q=(H=S==null?void 0:S.response)==null?void 0:H.data)==null?void 0:q.message)||(S==null?void 0:S.message)||"获取文档列表时发生错误";g.error(V),y.value=[],x.total=0}finally{R.value=!1}},G=async()=>{k.value=!0;try{Q.value=await Je()}catch(u){console.error("Error fetching document type tree:",u),g.error("获取文档类型失败")}finally{k.value=!1}},d=async()=>{k.value=!0;try{n.value=await Fe()}catch(u){console.error("Error fetching department tree:",u),g.error("获取部门失败")}finally{k.value=!1}},h=()=>{x.page=1,P()},U=()=>{var u;(u=L.value)==null||u.resetFields(),s.docTypeId=null,s.sourceDepartmentId=null,s.docTypeNameFilter="",s.sourceDepartmentNameFilter="",s.handoverDateRange=null,s.docName="",s.submitter="",s.receiver="",s.signer="",h()},M=u=>{const{prop:r,order:T}=u;r&&T?P({prop:r,order:T}):P()},I=u=>{P()},z=u=>{P()},i=()=>{F.value?F.value.open("add"):(console.error("DocumentFormDialog reference is null"),g.error("无法打开新增对话框，请刷新重试"))},o=u=>{F.value?F.value.open("edit",u):(console.error("DocumentFormDialog reference is null"),g.error("无法打开编辑对话框，请刷新重试"))},a=u=>{F.value?F.value.open("view",u):(console.error("DocumentFormDialog reference is null"),g.error("无法打开查看对话框，请刷新重试"))},m=async u=>{if(typeof u.id!="number"){g.error("无法删除：文档 ID 无效");return}try{await qe.confirm(`确定要删除文档 "${u.docName||"未知名称"}" 吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),R.value=!0,await We(u.id),g.success(`删除文档 "${u.docName||"未知名称"}" 成功`),P()}catch(r){r!=="cancel"&&(console.error("删除文档失败:",r),g.error(`删除文档失败: ${(r==null?void 0:r.message)||"未知错误"}`))}finally{R.value=!1}},c=u=>{E.value=u.map(r=>r.id).filter(r=>typeof r=="number"),console.log("[Debug] DocumentListView: Selection changed, selected IDs:",E.value)},b=()=>{if(C.value){const u=y.value.map(r=>r.id).filter(r=>typeof r=="number");C.value.open(s,E.value,u)}},D=async()=>{if(console.log("[DocumentListView] handleImportClick called"),!$.value){console.error("[DocumentListView] Import dialog reference is null"),g.error("导入对话框组件未正确加载，请刷新页面重试");return}try{console.log("[DocumentListView] Opening import dialog..."),await $.value.open(),console.log("[DocumentListView] Import dialog opened successfully.")}catch(u){console.error("[DocumentListView] Error opening import dialog:",u),g.error("打开导入对话框时发生错误，请刷新页面重试")}},J=(u,r=!1)=>{if(!u)return"-";try{const T=new Date(u);if(isNaN(T.getTime()))return"-";const H=T.getFullYear(),q=(T.getMonth()+1).toString().padStart(2,"0"),S=T.getDate().toString().padStart(2,"0");if(r)return`${H}-${q}-${S}`;const V=T.getHours().toString().padStart(2,"0"),oe=T.getMinutes().toString().padStart(2,"0"),p=T.getSeconds().toString().padStart(2,"0");return`${H}-${q}-${S} ${V}:${oe}:${p}`}catch(T){return console.error("Error formatting date:",u,T),"-"}},W=u=>J(u,!0),le=u=>J(u);Ee(()=>{console.log("[DocumentListView] onMounted STARTING..."),G(),d(),P()});const ae=u=>{u!==null&&(s.docTypeNameFilter="")},w=u=>{u&&(s.docTypeId=null)},ce=u=>{u!==null&&(s.sourceDepartmentNameFilter="")},te=u=>{u&&(s.sourceDepartmentId=null)};return(u,r)=>{const T=O("el-form-item"),H=O("el-date-picker"),q=O("el-button"),S=O("el-card"),V=O("el-table-column"),oe=Ie("loading");return A(),se("div",nl,[e(S,{class:"search-card",shadow:"never"},{default:l(()=>[e(t(fe),{model:s,ref_key:"searchFormRef",ref:L,"label-width":"70px",class:"search-form"},{default:l(()=>[e(T,{label:"文档名称",prop:"docName"},{default:l(()=>[e(t(Z),{modelValue:s.docName,"onUpdate:modelValue":r[0]||(r[0]=p=>s.docName=p),placeholder:"输入文档名称",clearable:"",style:{width:"220px"}},null,8,["modelValue"])]),_:1}),e(T,{label:"提交人",prop:"submitter"},{default:l(()=>[e(t(Z),{modelValue:s.submitter,"onUpdate:modelValue":r[1]||(r[1]=p=>s.submitter=p),placeholder:"输入提交人",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(T,{label:"接收人",prop:"receiver"},{default:l(()=>[e(t(Z),{modelValue:s.receiver,"onUpdate:modelValue":r[2]||(r[2]=p=>s.receiver=p),placeholder:"输入接收人",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(T,{label:"文档类型",prop:"docTypeId"},{default:l(()=>[Y("div",sl,[e(t(he),{modelValue:s.docTypeId,"onUpdate:modelValue":r[3]||(r[3]=p=>s.docTypeId=p),placeholder:"选择精确类型",data:Q.value,props:N,"check-strictly":"","render-after-expand":!1,clearable:"",loading:k.value,style:{width:"180px"},onChange:ae},null,8,["modelValue","data","loading"]),e(t(Z),{modelValue:s.docTypeNameFilter,"onUpdate:modelValue":r[4]||(r[4]=p=>s.docTypeNameFilter=p),placeholder:"或输入模糊类型",clearable:"",style:{width:"150px"},onInput:w,onClear:r[5]||(r[5]=()=>{s.docTypeNameFilter=""})},null,8,["modelValue"])])]),_:1}),e(T,{label:"来源部门",prop:"sourceDepartmentId"},{default:l(()=>[Y("div",dl,[e(t(he),{modelValue:s.sourceDepartmentId,"onUpdate:modelValue":r[6]||(r[6]=p=>s.sourceDepartmentId=p),placeholder:"选择精确部门",data:n.value,props:N,"check-strictly":"","render-after-expand":!1,clearable:"",loading:k.value,style:{width:"180px"},onChange:ce},null,8,["modelValue","data","loading"]),e(t(Z),{modelValue:s.sourceDepartmentNameFilter,"onUpdate:modelValue":r[7]||(r[7]=p=>s.sourceDepartmentNameFilter=p),placeholder:"或输入模糊部门",clearable:"",style:{width:"150px"},onInput:te,onClear:r[8]||(r[8]=()=>{s.sourceDepartmentNameFilter=""})},null,8,["modelValue"])])]),_:1}),e(T,{label:"签章人",prop:"signer"},{default:l(()=>[e(t(Z),{modelValue:s.signer,"onUpdate:modelValue":r[9]||(r[9]=p=>s.signer=p),placeholder:"签章人",clearable:"",style:{width:"120px"}},null,8,["modelValue"])]),_:1}),e(T,{label:"交接日期",prop:"handoverDateRange"},{default:l(()=>[e(H,{modelValue:s.handoverDateRange,"onUpdate:modelValue":r[10]||(r[10]=p=>s.handoverDateRange=p),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"220px"}},null,8,["modelValue"])]),_:1}),e(T,{label:"",class:"search-buttons"},{default:l(()=>[e(q,{type:"primary",onClick:h,icon:t(Ue)},{default:l(()=>r[13]||(r[13]=[v("搜索")])),_:1},8,["icon"]),e(q,{onClick:U,icon:t($e)},{default:l(()=>r[14]||(r[14]=[v("重置")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),e(S,{class:"table-card",shadow:"never"},{default:l(()=>[Y("div",ul,[Y("div",il,[e(q,{type:"primary",onClick:i,icon:t(Re)},{default:l(()=>r[15]||(r[15]=[v("新增文档")])),_:1},8,["icon"]),e(q,{type:"success",onClick:D,icon:t(Te)},{default:l(()=>r[16]||(r[16]=[v("批量导入")])),_:1},8,["icon"]),e(q,{type:"warning",onClick:b,icon:t(Le),style:{"margin-left":"10px"}},{default:l(()=>r[17]||(r[17]=[v("批量导出")])),_:1},8,["icon"])])]),xe((A(),j(t(Be),{ref_key:"tableRef",ref:_,data:y.value,style:{width:"100%"},stripe:"",border:"",onSortChange:M,"default-sort":{prop:"createdAt",order:"descending"},onSelectionChange:c,"row-key":"id"},{default:l(()=>[e(V,{type:"selection",width:"55","reserve-selection":!0}),e(V,{prop:"id",label:"ID",width:"80",sortable:""}),e(V,{prop:"docName",label:"文档名称","min-width":"200","show-overflow-tooltip":"",sortable:"custom"}),e(V,{prop:"docTypeName",label:"文档类型",width:"150"}),e(V,{prop:"departmentName",label:"来源部门",width:"150"}),e(V,{prop:"submitter",label:"提交人",width:"120",sortable:"custom"}),e(V,{prop:"receiver",label:"接收人",width:"120"}),e(V,{prop:"signer",label:"签章人",width:"120",sortable:"custom"}),e(V,{prop:"handoverDate",label:"交接日期",width:"120",align:"center",sortable:"custom"},{default:l(({row:p})=>[v(X(W(p.handoverDate)),1)]),_:1}),e(V,{prop:"createdBy",label:"创建人",width:"120"}),e(V,{prop:"createdAt",label:"创建时间",width:"160",align:"center",sortable:"custom"},{default:l(({row:p})=>[v(X(le(p.createdAt)),1)]),_:1}),e(V,{label:"操作",width:"180",align:"center",fixed:"right"},{default:l(({row:p})=>[e(q,{type:"primary",link:"",size:"small",icon:t(Pe),onClick:ve=>a(p)},{default:l(()=>r[18]||(r[18]=[v("查看")])),_:2},1032,["icon","onClick"]),e(q,{type:"primary",link:"",size:"small",icon:t(ze),onClick:ve=>o(p)},{default:l(()=>r[19]||(r[19]=[v("编辑")])),_:2},1032,["icon","onClick"]),e(q,{type:"danger",link:"",size:"small",icon:t(Ae),onClick:ve=>m(p)},{default:l(()=>r[20]||(r[20]=[v("删除")])),_:2},1032,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[oe,R.value]]),e(t(Me),{class:"pagination-container","current-page":x.page,"onUpdate:currentPage":r[11]||(r[11]=p=>x.page=p),"page-size":x.pageSize,"onUpdate:pageSize":r[12]||(r[12]=p=>x.pageSize=p),"page-sizes":[10,20,50,100],total:x.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:I,onCurrentChange:z},null,8,["current-page","page-size","total"])]),_:1}),e(Xe,{ref_key:"documentFormDialogRef",ref:F,"doc-type-tree-data":Q.value,"department-tree-data":n.value,onSuccess:P},null,8,["doc-type-tree-data","department-tree-data"]),e(ll,{ref_key:"exportOptionsDialogRef",ref:C},null,512),e(rl,{ref_key:"importDialogRef",ref:$},null,512)])}}}),fl=ie(cl,[["__scopeId","data-v-848972f4"]]);export{fl as default};
