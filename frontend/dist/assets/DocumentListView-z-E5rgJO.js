import{w as ne,d as xe,r as p,l as Ce,m as te,p as K,g as a,u as e,q as Ne,n as be,E as h,i as I,b as Ee,e as A,s as re,c as Re,v as Le,f as l,x as oe,h as pe,y as H,z as M,k as b,F as ke,A as Fe,B as he,j as C,C as Ye,D as Qe,G as ye,t as G,H as He,I as Ke,J as Ze,_ as Te,K as tl,L as Se,o as Xe,M as ol,N as rl,O as Pe,P as nl,Q as Ie,R as sl,S as Ve,T as Ae,U as ee,V as Me,W as We,X as il,Y as je,Z as Ue,$ as dl,a0 as Ge,a1 as ul,a2 as cl,a3 as Oe,a4 as pl,a5 as $e,a6 as qe,a7 as _e,a8 as ml,a9 as fl,aa as el,ab as vl,ac as gl,ad as yl,ae as bl,af as hl,ag as Dl,ah as wl,ai as _l,aj as kl}from"./index-CM9mD3KB.js";import{g as xl}from"./doctype-BhrbNOta.js";import{r as Tl,a as Il}from"./task-BoEr0r9-.js";const Vl=(F,S)=>{if(!(F instanceof Blob)){console.error("[downloadBlob] Invalid Blob object received.");return}const $=window.URL.createObjectURL(F),P=document.createElement("a");P.style.display="none",P.href=$,P.download=S,document.body.appendChild(P);try{P.click()}catch(W){console.error("[downloadBlob] Failed to trigger download click:",W)}document.body.removeChild(P),window.URL.revokeObjectURL($),console.log(`[downloadBlob] Download triggered for ${S}, Blob URL revoked.`)},Cl=async F=>{console.log("[api/document.ts:getDocuments] Entry. Received params:",JSON.stringify(F,null,2));try{console.log("[api/document.ts:getDocuments] Params BEFORE passing to request util:",JSON.stringify(F,null,2));const S=await ne.get("/documents",{params:F});return console.log("[api/document.ts] Response from wrappedRequest.get (should be PageResult):",S),S||{list:[],total:0}}catch(S){return console.error("[api/document.ts] Error in getDocuments:",S),{list:[],total:0}}},El=async F=>await ne.post("/documents",F),Fl=async(F,S)=>await ne.put(`/documents/${F}`,S),Nl=async F=>{await ne.delete(`/documents/${F}`)},ll=async F=>await ne.get(`/documents/${F}`),Sl=async(F,S)=>await ne.post(`/documents/${F}/files`,S),$l=async F=>{await ne.delete(`/documents/${F}/files`)},Pl=async F=>await ne.post(`/documents/${F}/start-processing`),al=async(F,S)=>{try{const $=await ne.get(`/documents/files/${F}/download`,{responseType:"blob"});Vl($,S)}catch($){throw console.error(`[api/document.ts] Error downloading file ${F}:`,$),$}},Je=async F=>{try{const S=await ne.get(`/documents/files/${F}/download`,{responseType:"blob"});if(S instanceof Blob)return S;throw console.error("Expected Blob but received:",S),new Error("无法获取文件 Blob 数据，响应类型不匹配")}catch(S){throw console.error(`Error fetching file blob for preview (ID: ${F}):`,S),new Error("获取文件预览失败")}},Ul={key:0,class:"file-management-area"},Rl={style:{"margin-top":"20px"}},Ll={class:"el-upload__tip"},zl={key:0,style:{color:"red","margin-left":"10px"}},Bl={style:{"margin-top":"15px","text-align":"right"}},Al={class:"dialog-footer"},Ml=xe({__name:"DocumentFormDialog",props:{docTypeTreeData:{},departmentTreeData:{}},emits:["success"],setup(F,{expose:S,emit:$}){const P=F,W=$,V=p(!1),g=p(!1),Y=p(),i=p("add"),E=p(null),L=p(!1),B=p(!1),z=p(!1),O=p(!1),le=()=>({doc_name:"",docTypeId:null,docTypeName:"",sourceDepartmentId:null,sourceDepartmentName:"",submitter:"",receiver:"",signer:null,storageLocation:null,handoverDate:void 0,remarks:""});let m=Ce(le());const N=p([]),d=p(!1),D=p([]),R=p(),x=te(()=>i.value==="view"),k=te(()=>i.value==="add"?"新增文档":i.value==="edit"?"编辑文档":"查看文档信息"),q={value:"id",label:"name",children:"children"},y=te(()=>N.value.some(o=>o.processingStatus==="pending")),T=te(()=>{const o=localStorage.getItem("authToken");return o?{Authorization:`Bearer ${o}`}:{}}),Q=Ce({doc_name:[{required:!0,message:"请输入文档名称",trigger:"blur"}],submitter:[{required:!0,message:"请输入提交人",trigger:"blur"}],receiver:[{required:!0,message:"请输入接收人",trigger:"blur"}],signer:[{max:50,message:"签章人名称过长",trigger:"blur"}],storageLocation:[{max:100,message:"存放位置过长",trigger:"blur"}],remarks:[{max:1e3,message:"备注过长",trigger:"blur"}]}),J=p({}),Z=(o,t)=>{var _;console.log("[Dialog] Open called with type:",o,"and data:",t),i.value=o,V.value=!0,g.value=!1,E.value=null,N.value=[],D.value=[],(_=R.value)==null||_.clearFiles(),L.value=o==="add",B.value=o==="add",z.value=!1,O.value=!1;const w=f=>{if(f==null||f==="")return null;if(typeof f=="number")return f;const c=parseInt(f,10);return isNaN(c)?null:c};be(async()=>{var f,c;if((f=Y.value)==null||f.resetFields(),Object.assign(m,le()),(o==="edit"||o==="view")&&t&&t.id){const v=t.id;E.value=v,d.value=!0,g.value=!0;try{console.log(`[Dialog] Fetching details for document ID: ${v} (Mode: ${o})`);const r=await ll(v);if(r){m.doc_name=r.docName??"",m.submitter=r.submitter??"",m.receiver=r.receiver??"",m.signer=r.signer??null,m.storageLocation=r.storageLocation??null,m.handoverDate=r.handoverDate??void 0,m.remarks=r.remarks??"",m.sourceDepartmentId=w(r.sourceDepartmentId),m.sourceDepartmentName=r.sourceDepartmentName??null;const n=w(r.docTypeId),j=(c=P.docTypeTreeData)==null?void 0:c.some(U=>se(U,n));m.docTypeId=j?n:null,m.docTypeName=j?r.docTypeName??null:null,o==="edit"?(N.value=r.files||[],console.log("[Dialog] Associated files updated for edit list:",N.value)):N.value=[]}else console.error(`[Dialog] Document details not found for ID: ${v}`),h.error("无法加载文档详情")}catch(r){console.error(`[Dialog] Error fetching details for ID ${v}:`,r),h.error("加载文档详情失败")}finally{g.value=!1}}else o==="add"&&(d.value=!1)})},se=(o,t)=>!o||t===null||t===void 0?!1:o.id===t?!0:o.children&&o.children.length>0?o.children.some(w=>se(w,t)):!1,X=o=>{m.docTypeId=o;const t=(_,f)=>{if(!_||f===null)return null;for(const c of _){if(c.id===f)return c;if(c.children&&c.children.length>0){const v=t(c.children,f);if(v)return v}}return null},w=t(P.docTypeTreeData,o);m.docTypeName=w?w.name:null,z.value=!0,console.log(`[Dialog] DocType changed. Selected ID: ${o}, Updated Name: ${m.docTypeName}, User Modified: ${z.value}`)},de=o=>{m.sourceDepartmentId=o;const t=(_,f)=>{if(!_||f===null)return null;for(const c of _){if(c.id===f)return c;if(c.children&&c.children.length>0){const v=t(c.children,f);if(v)return v}}return null},w=t(P.departmentTreeData,o);m.sourceDepartmentName=w?w.name:null,O.value=!0,console.log(`[Dialog] Department changed. Selected ID: ${o}, Updated Name: ${m.sourceDepartmentName}, User Modified: ${O.value}`)},me=async()=>{if(!(i.value==="view"||!Y.value))try{await Y.value.validate(),g.value=!0;let o={docName:m.doc_name,submitter:m.submitter,receiver:m.receiver,signer:m.signer??void 0,storageLocation:m.storageLocation??void 0,handoverDate:m.handoverDate,remarks:m.remarks};z.value&&(o.docTypeId=m.docTypeId),O.value&&(o.sourceDepartmentId=m.sourceDepartmentId);let t=null,w=!1;if(console.log("[Dialog] Submitting data:",o),i.value==="add"){const _=await El(o);if(_&&_.id)t=_.id,E.value=t,w=!0,h.success("文档新增成功");else throw new Error("创建文档后未能获取到有效的文档 ID")}else i.value==="edit"&&E.value&&(await Fl(E.value,o),t=E.value,h.success("文档更新成功"));if(t&&D.value.length>0){console.log(`[handleSubmit] Document ${i.value} successful (ID: ${t}). Uploading ${D.value.length} selected files.`);try{await ie(t)}catch(_){console.error("[handleSubmit] Uploading files after save failed:",_),h.error("文档信息已保存，但文件上传失败。")}}else if(t&&w&&y.value){console.log(`[handleSubmit] Document ${t} saved. Checking for pending files...`),console.log(`[handleSubmit] Pending files detected (canStartProcessing=${y.value}). Attempting to automatically start processing.`);try{await ge()}catch(_){console.error("[handleSubmit] Auto-triggering processing failed:",_),h.error("文档已保存，但自动触发文件处理失败。")}}else t&&console.log(`[handleSubmit] Document ${t} ${i.value} successful. No files selected for upload or no pending processing needed.`);V.value=!1,W("success")}catch(o){console.error("提交文档失败:",o),h.error(`操作失败: ${(o==null?void 0:o.message)||"请检查表单或联系管理员"}`)}finally{g.value=!1}},fe=()=>{g.value||(V.value=!1)},ve=(o,t)=>{h.warning(`当前限制选择 10 个文件，本次选择了 ${o.length} 个文件，共选择了 ${o.length+t.length} 个文件`)},ue=async()=>{var o;if(!(!E.value||N.value.length===0))try{await Ze.confirm("确定要清空该文档下的所有关联文件吗？此操作不可恢复。","警告",{confirmButtonText:"确定清空",cancelButtonText:"取消",type:"warning"}),g.value=!0,await $l(E.value),h.success("所有文件已清空"),N.value=[],D.value=[],(o=R.value)==null||o.clearFiles()}catch(t){t!=="cancel"&&(console.error("Clear all files error:",t),h.error(t.message||"清空文件失败"))}finally{g.value=!1}},ie=async o=>{var _;const t=o??E.value;if(!t||D.value.length===0)return;const w=new FormData;D.value.forEach(f=>{f.raw&&w.append("files",f.raw)}),g.value=!0;try{const f=await Sl(t,w);h.success("文件上传成功"),N.value=f.files||[],console.log("[Upload Success] Associated files updated:",JSON.parse(JSON.stringify(N.value))),D.value=[],(_=R.value)==null||_.clearFiles(),!o&&y.value&&(console.log("[handleUploadFiles] Standalone upload successful. Triggering processing."),await ge())}catch(f){throw console.error("Upload files error:",f),h.error(f.message||"文件上传失败"),f}finally{g.value=!1}},ge=async()=>{if(!E.value||!y.value){console.warn("[handleStartProcessing] No current ID or no processable files.");return}try{const o=await Pl(E.value);h.success(`已成功触发 ${o.triggeredCount} 个文件的处理任务`)}catch(o){throw console.error("Start processing error:",o),o}},De=o=>{if(!o)return"未知";const t=o.toLowerCase();return t.includes("pdf")?"PDF 文件":t.includes("wordprocessingml")||t.includes("msword")?"Word 文档":t.includes("spreadsheetml")||t.includes("excel")||t.includes("ms-excel")?"Excel 表格":t.includes("presentationml")||t.includes("powerpoint")||t.includes("ms-powerpoint")?"PPT 演示文稿":t.startsWith("image/jpeg")?"JPEG 图像":t.startsWith("image/png")?"PNG 图像":t.startsWith("image/gif")?"GIF 图像":t.startsWith("image/bmp")?"BMP 图像":t.startsWith("text/plain")?"纯文本":t.startsWith("application/zip")?"ZIP 压缩包":t.startsWith("application/x-rar-compressed")?"RAR 压缩包":t.split("/")[0]||"未知文件"},we=o=>{switch(o){case"pending":return"待处理";case"processing":return"处理中";case"completed":return"已完成";case"failed":return"处理失败";default:return"未知状态"}},u=o=>{switch(o){case"pending":return"warning";case"processing":return"info";case"completed":return"success";case"failed":return"danger";default:return"info"}},s=async o=>{if(!(!o||!o.id||!o.fileName)){J.value[o.id]=!0;try{await al(o.id,o.fileName)}catch(t){console.error("Download file error in edit:",t),h.error("下载文件失败")}finally{J.value[o.id]=!1}}};return S({open:Z}),(o,t)=>{const w=pe("el-form-item"),_=pe("el-date-picker"),f=Re("loading");return I(),K(e(Ne),{modelValue:V.value,"onUpdate:modelValue":t[11]||(t[11]=c=>V.value=c),title:k.value,width:"60%","before-close":fe,draggable:"","destroy-on-close":""},{footer:a(()=>[C("span",Al,[l(e(M),{onClick:fe},{default:a(()=>[b(G(x.value?"关闭":"取消"),1)]),_:1}),x.value?re("",!0):(I(),K(e(M),{key:0,type:"primary",onClick:me,loading:g.value},{default:a(()=>t[21]||(t[21]=[b("确定")])),_:1},8,["loading"]))])]),default:a(()=>[Ee((I(),K(e(Le),{ref_key:"formRef",ref:Y,model:e(m),rules:x.value?{}:Q,"label-width":"100px",disabled:x.value},{default:a(()=>[l(e(he),{gutter:20},{default:a(()=>[l(e(oe),{span:12},{default:a(()=>[l(w,{label:"文档名称",prop:"doc_name"},{default:a(()=>[l(e(H),{modelValue:e(m).doc_name,"onUpdate:modelValue":t[0]||(t[0]=c=>e(m).doc_name=c),placeholder:"请输入文档名称",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),l(e(oe),{span:12},{default:a(()=>[l(w,{label:"文档类型",prop:"docTypeName"},{default:a(()=>[x.value?(I(),K(e(H),{key:0,"model-value":e(m).docTypeName,disabled:"",placeholder:"---"},null,8,["model-value"])):L.value?(I(),K(e(Fe),{key:2,"model-value":e(m).docTypeId,"onUpdate:modelValue":X,placeholder:"请选择新文档类型",data:P.docTypeTreeData,props:q,"check-strictly":"","render-after-expand":!1,clearable:"",style:{width:"100%"}},null,8,["model-value","data"])):(I(),A(ke,{key:1},[l(e(H),{"model-value":e(m).docTypeName,disabled:"",placeholder:"未指定",style:{width:"calc(100% - 70px)","margin-right":"8px"}},null,8,["model-value"]),l(e(M),{onClick:t[1]||(t[1]=c=>L.value=!0),disabled:x.value},{default:a(()=>t[12]||(t[12]=[b("更改")])),_:1},8,["disabled"])],64))]),_:1})]),_:1})]),_:1}),l(e(he),{gutter:20},{default:a(()=>[l(e(oe),{span:12},{default:a(()=>[l(w,{label:"来源部门",prop:"sourceDepartmentName"},{default:a(()=>[x.value?(I(),K(e(H),{key:0,"model-value":e(m).sourceDepartmentName,disabled:"",placeholder:"---"},null,8,["model-value"])):B.value?(I(),K(e(Fe),{key:2,"model-value":e(m).sourceDepartmentId,"onUpdate:modelValue":de,placeholder:"请选择新来源部门",data:P.departmentTreeData,props:q,"check-strictly":"","render-after-expand":!1,clearable:"",style:{width:"100%"}},null,8,["model-value","data"])):(I(),A(ke,{key:1},[l(e(H),{"model-value":e(m).sourceDepartmentName,disabled:"",placeholder:"未指定",style:{width:"calc(100% - 70px)","margin-right":"8px"}},null,8,["model-value"]),l(e(M),{onClick:t[2]||(t[2]=c=>B.value=!0),disabled:x.value},{default:a(()=>t[13]||(t[13]=[b("更改")])),_:1},8,["disabled"])],64))]),_:1})]),_:1}),l(e(oe),{span:12},{default:a(()=>[l(w,{label:"交接日期",prop:"handoverDate"},{default:a(()=>[l(_,{modelValue:e(m).handoverDate,"onUpdate:modelValue":t[3]||(t[3]=c=>e(m).handoverDate=c),type:"date",placeholder:"选择交接日期","value-format":"YYYY-MM-DD",style:{width:"100%"},disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),l(e(he),{gutter:20},{default:a(()=>[l(e(oe),{span:12},{default:a(()=>[l(w,{label:"提交人",prop:"submitter"},{default:a(()=>[l(e(H),{modelValue:e(m).submitter,"onUpdate:modelValue":t[4]||(t[4]=c=>e(m).submitter=c),placeholder:"请输入提交人",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),l(e(oe),{span:12},{default:a(()=>[l(w,{label:"接收人",prop:"receiver"},{default:a(()=>[l(e(H),{modelValue:e(m).receiver,"onUpdate:modelValue":t[5]||(t[5]=c=>e(m).receiver=c),placeholder:"请输入接收人",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),l(e(he),{gutter:20},{default:a(()=>[l(e(oe),{span:12},{default:a(()=>[l(w,{label:"签署人",prop:"signer"},{default:a(()=>[l(e(H),{modelValue:e(m).signer,"onUpdate:modelValue":t[6]||(t[6]=c=>e(m).signer=c),placeholder:"请输入签署人 (可选)",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),l(e(oe),{span:12},{default:a(()=>[l(w,{label:"存放位置",prop:"storageLocation"},{default:a(()=>[l(e(H),{modelValue:e(m).storageLocation,"onUpdate:modelValue":t[7]||(t[7]=c=>e(m).storageLocation=c),placeholder:"请输入存放位置 (可选)",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),l(w,{label:"备注",prop:"remarks"},{default:a(()=>[l(e(H),{modelValue:e(m).remarks,"onUpdate:modelValue":t[8]||(t[8]=c=>e(m).remarks=c),type:"textarea",rows:3,placeholder:"请输入备注信息 (可选)",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model","rules","disabled"])),[[f,g.value]]),x.value?re("",!0):(I(),A("div",Ul,[l(e(Ye),{"content-position":"left"},{default:a(()=>t[14]||(t[14]=[b("文件管理")])),_:1}),Ee((I(),K(e(Qe),{data:N.value,style:{width:"100%"},border:"",size:"small"},{default:a(()=>[l(e(ye),{type:"index",label:"序号",width:"60",align:"center"}),l(e(ye),{prop:"fileName",label:"文件名","show-overflow-tooltip":""}),l(e(ye),{prop:"fileType",label:"类型",width:"120"},{default:a(({row:c})=>[C("span",null,G(De(c.fileType)),1)]),_:1}),l(e(ye),{prop:"fileSize",label:"大小",width:"100"},{default:a(({row:c})=>[b(G((c.fileSize/1024).toFixed(2))+" KB ",1)]),_:1}),l(e(ye),{prop:"processingStatus",label:"状态",width:"100"},{default:a(({row:c})=>[l(e(He),{type:u(c.processingStatus),size:"small"},{default:a(()=>[b(G(we(c.processingStatus)),1)]),_:2},1032,["type"])]),_:1}),l(e(ye),{label:"操作",width:"100",align:"center"},{default:a(({row:c})=>[l(e(M),{type:"primary",link:"",size:"small",onClick:v=>s(c),loading:J.value[c.id]},{default:a(()=>t[15]||(t[15]=[b(" 下载 ")])),_:2},1032,["onClick","loading"])]),_:1})]),_:1},8,["data"])),[[f,g.value]]),C("div",Rl,[l(e(Ke),{ref_key:"uploadRef",ref:R,"file-list":D.value,"onUpdate:fileList":t[9]||(t[9]=c=>D.value=c),action:"","auto-upload":!1,multiple:"",limit:10,"on-exceed":ve,headers:T.value,"http-request":()=>{},"before-upload":()=>!g.value,disabled:g.value},{trigger:a(()=>[l(e(M),{type:"primary",disabled:g.value},{default:a(()=>t[16]||(t[16]=[b("选择文件")])),_:1},8,["disabled"])]),tip:a(()=>[C("div",Ll,[t[17]||(t[17]=b(" 支持 PDF, Word, JPG, PNG 等格式，最多上传 10 个文件。 ")),t[18]||(t[18]=C("span",{style:{color:"#e6a23c","margin-left":"5px"}},"注意：PDF、JPG、PNG 可直接预览，其他格式需下载后查看。",-1)),i.value==="edit"?(I(),A("span",zl,"注意：上传新文件将替换所有现有文件！")):re("",!0)])]),_:1},8,["file-list","headers","before-upload","disabled"])]),C("div",Bl,[l(e(M),{type:"danger",onClick:ue,disabled:N.value.length===0||g.value,loading:g.value},{default:a(()=>t[19]||(t[19]=[b(" 清空文件 ")])),_:1},8,["disabled","loading"]),l(e(M),{type:"success",onClick:t[10]||(t[10]=()=>ie()),disabled:D.value.length===0||g.value||i.value==="add",loading:g.value},{default:a(()=>t[20]||(t[20]=[b(" 上传选中文件 ")])),_:1},8,["disabled","loading"])])]))]),_:1},8,["modelValue","title"])}}}),Wl=Te(Ml,[["__scopeId","data-v-cefe5a42"]]),jl={key:0,class:"file-list-container"},Gl=["onClick"],Ol={class:"file-item-label"},ql={key:3,class:"selected-file-details"},Jl={class:"preview-area",style:{"margin-top":"15px","text-align":"center"}},Yl={key:0,class:"preview-placeholder"},Ql={key:1,class:"image-gallery-wrapper"},Hl=["onClick"],Kl={class:"thumbnail-container"},Zl=["src"],Xl={key:1,class:"thumbnail-placeholder"},ea=["onClick"],la={class:"thumbnail-footer"},aa={class:"file-type"},ta={class:"file-size"},oa={key:2,class:"pdf-preview-container"},ra={class:"pdf-toolbar"},na={class:"pdf-container"},sa={key:0,class:"pdf-loading-overlay"},ia={key:3,class:"file-action-card"},da={class:"icon-container"},ua={class:"action-info"},ca={class:"file-type"},pa={class:"dialog-footer"},ma=xe({__name:"DocumentFileViewDialog",setup(F,{expose:S}){const $=p(!1),P=p(!1),W=p(null),V=p([]),g=p(null),Y=p({}),i=p(!1),E=p({}),L=p(!1),B=p(0),z=p([]),O=te(()=>V.value.filter(r=>ve(r.fileType))),le=te(()=>O.value.length>0),m=p(null),N=p(!1),d=tl(null),D=p(1),R=p(0),x=p(1),k=p(null),q=p(!1),y=p(null),T=p(!1),Q=p(!0),J=p(!1),Z=async r=>{W.value=r,$.value=!0,P.value=!0,V.value=[],g.value=null,E.value={},d.value=null,D.value=1,R.value=0,x.value=1;try{const n=await ll(r);n&&n.files?(V.value=n.files,V.value.length>0&&(ie(V.value[0]),ge(V.value))):h.error("无法加载附件列表")}catch(n){console.error(`Error fetching files for document ID ${r}:`,n),h.error("加载附件列表失败")}finally{P.value=!1,be(()=>c())}},se=r=>{Object.values(E.value).forEach(n=>{n&&URL.revokeObjectURL(n)}),E.value={},d.value&&(d.value.destroy(),d.value=null),k.value&&(k.value.cancel(),k.value=null),$.value=!1,r&&r()},X=async r=>{if(!(!r||!r.id||!r.fileName)){Y.value[r.id]=!0;try{await al(r.id,r.fileName)}catch(n){console.error("Download file error:",n),h.error("下载文件失败")}finally{Y.value[r.id]=!1}}},de=r=>{if(!r)return"未知";const n=r.toLowerCase();return n.includes("pdf")?"PDF 文件":n.includes("wordprocessingml")||n.includes("msword")?"Word 文档":n.includes("spreadsheetml")||n.includes("excel")||n.includes("ms-excel")?"Excel 表格":n.includes("presentationml")||n.includes("powerpoint")||n.includes("ms-powerpoint")?"PPT 演示文稿":n.startsWith("image/jpeg")?"JPEG 图像":n.startsWith("image/png")?"PNG 图像":n.startsWith("image/gif")?"GIF 图像":n.startsWith("image/bmp")?"BMP 图像":n.startsWith("text/plain")?"纯文本":n.startsWith("application/zip")?"ZIP 压缩包":n.startsWith("application/x-rar-compressed")?"RAR 压缩包":n.split("/")[0]||"未知文件"},me=r=>{switch(r){case"pending":return"待处理";case"processing":return"处理中";case"completed":return"已完成";case"failed":return"处理失败";default:return"未知状态"}},fe=r=>{switch(r){case"pending":return"warning";case"processing":return"info";case"completed":return"success";case"failed":return"danger";default:return"info"}},ve=r=>{const n=r.toLowerCase();return n.startsWith("image/")&&n!=="image/bmp"},ue=r=>r==="application/pdf",ie=r=>{g.value=r,ue(r.fileType)?u(r.id):d.value&&(d.value.destroy(),d.value=null)},ge=r=>{r.forEach(n=>{ve(n.fileType)&&!E.value[n.id]&&De(n.id)})},De=async r=>{if(!E.value[r]){i.value=!0;try{const n=await Je(r),j=URL.createObjectURL(n);E.value[r]=j}catch(n){console.error(`Failed to load image preview for file ${r}:`,n)}finally{i.value=!1}}},we=async()=>{if(q.value)return Promise.resolve(await Oe(()=>import("./pdf-BOQpkqLt.js"),[]));try{N.value=!0;const r=await Oe(()=>import("./pdf-BOQpkqLt.js"),[]);return r.GlobalWorkerOptions.workerSrc="/pdf.worker.min.mjs",q.value=!0,r}catch(r){throw console.error("Failed to load PDF.js:",r),h.error("PDF预览组件加载失败"),r}finally{N.value=!1}},u=async r=>{if(r){D.value=1,R.value=0,x.value=1,d.value&&(d.value.destroy(),d.value=null),N.value=!0;try{const n=await we();if(!n)throw new Error("PDF.js加载失败");const U=await(await Je(r)).arrayBuffer(),ae=await n.getDocument({data:U}).promise;d.value=ae,R.value=ae.numPages,s()}catch(n){console.error(`Failed to load PDF preview for file ${r}:`,n),h.error("PDF预览加载失败: "+(n instanceof Error?n.message:String(n)))}finally{N.value=!1}}},s=async()=>{k.value&&(k.value.cancel(),k.value=null);const r=d.value,n=m.value;if(!(!r||!n))try{N.value=!0;const j=await r.getPage(D.value),U=rl(j),ae=U.getViewport({scale:x.value}),ce=n.getContext("2d");if(!ce)throw new Error("无法获取canvas上下文");n.height=ae.height,n.width=ae.width;const ze={canvasContext:ce,viewport:ae},Be=U.render(ze);k.value=Be,await Be.promise,k.value=null}catch(j){j&&j.name!=="RenderingCancelledException"&&console.error("渲染PDF页面失败:",j),k.value=null}finally{N.value=!1}},o=()=>{D.value<R.value&&D.value++},t=()=>{D.value>1&&D.value--},w=()=>{x.value<2&&(x.value+=.25)},_=()=>{x.value>.5&&(x.value-=.25)},f=r=>{const n=O.value.findIndex(j=>j.id===r);n!==-1&&(z.value=O.value.map(j=>E.value[j.id]).filter(j=>!!j),B.value=n,L.value=!0)},c=()=>{if(!y.value)return;const r=y.value;T.value=r.scrollWidth>r.clientWidth,Q.value=r.scrollLeft<=5,J.value=r.scrollWidth-r.scrollLeft-r.clientWidth<=5},v=r=>{if(!y.value)return;const n=y.value;r==="left"&&!Q.value?n.scrollBy({left:-200,behavior:"smooth"}):r==="right"&&!J.value&&n.scrollBy({left:200,behavior:"smooth"}),setTimeout(()=>c(),300)};return Se([D,x],()=>{k.value&&(k.value.cancel(),k.value=null),d.value&&s()}),Se(g,r=>{k.value&&(k.value.cancel(),k.value=null),r&&ue(r.fileType)&&be(()=>{d.value?s():u(r.id)})}),Se(O,()=>{be(()=>c())},{deep:!0}),Xe(()=>{if(be(()=>{y.value&&(c(),y.value.addEventListener("scroll",c),window.addEventListener("resize",c))}),!document.getElementById("pdf-worker-loader")){const r=document.createElement("script");r.id="pdf-worker-loader",r.setAttribute("data-pdfjs-src","/pdf.worker.min.mjs"),document.head.appendChild(r)}}),ol(()=>{y.value&&y.value.removeEventListener("scroll",c),window.removeEventListener("resize",c),Object.values(E.value).forEach(r=>{r&&URL.revokeObjectURL(r)}),k.value&&(k.value.cancel(),k.value=null),d.value&&(d.value.destroy(),d.value=null)}),S({open:Z}),(r,n)=>{const j=Re("loading");return I(),K(e(Ne),{modelValue:$.value,"onUpdate:modelValue":n[7]||(n[7]=U=>$.value=U),title:"查看附件",width:"55%","before-close":se,draggable:"","destroy-on-close":"",class:"file-view-dialog"},{footer:a(()=>[C("span",pa,[l(e(M),{onClick:n[6]||(n[6]=()=>se())},{default:a(()=>n[15]||(n[15]=[b("关闭")])),_:1})])]),default:a(()=>[Ee((I(),A("div",null,[V.value.length>0?(I(),A("div",jl,[(I(!0),A(ke,null,Pe(V.value,(U,ae)=>{var ce;return I(),A("div",{key:U.id,class:Ve(["file-item",{selected:((ce=g.value)==null?void 0:ce.id)===U.id}]),onClick:ze=>ie(U)},[l(e(ee),{size:32},{default:a(()=>[l(e(Ge))]),_:1}),C("span",Ol,"文件 "+G(ae+1),1)],10,Gl)}),128))])):(I(),K(e(nl),{key:1,description:"该文档没有关联附件"})),V.value.length>0?(I(),K(e(Ye),{key:2})):re("",!0),g.value?(I(),A("div",ql,[C("h4",null,G(g.value.fileName),1),l(e(sl),{column:2,border:"",size:"small",style:{"margin-top":"10px"}},{default:a(()=>[l(e(Ie),{label:"类型"},{default:a(()=>[b(G(de(g.value.fileType)),1)]),_:1}),l(e(Ie),{label:"大小"},{default:a(()=>[b(G((g.value.fileSize/1024).toFixed(2))+" KB ",1)]),_:1}),l(e(Ie),{label:"状态"},{default:a(()=>[l(e(He),{type:fe(g.value.processingStatus),size:"small"},{default:a(()=>[b(G(me(g.value.processingStatus)),1)]),_:1},8,["type"])]),_:1}),l(e(Ie),{label:"操作"},{default:a(()=>[l(e(M),{type:"primary",link:"",size:"small",onClick:n[0]||(n[0]=U=>X(g.value)),loading:Y.value[g.value.id]},{default:a(()=>n[8]||(n[8]=[b(" 下载文件 ")])),_:1},8,["loading"])]),_:1})]),_:1}),C("div",Jl,[i.value?(I(),A("div",Yl," 加载预览中... ")):le.value&&V.value.length>0?(I(),A("div",Ql,[T.value?(I(),A("div",{key:0,class:Ve(["gallery-arrow gallery-arrow-left",{disabled:Q.value}]),onClick:n[1]||(n[1]=U=>v("left"))},[l(e(ee),{size:24},{default:a(()=>[l(e(Ae))]),_:1})],2)):re("",!0),C("div",{ref_key:"galleryRef",ref:y,class:"images-gallery"},[(I(!0),A(ke,null,Pe(O.value,U=>{var ae;return I(),A("div",{key:U.id,class:Ve(["image-thumbnail-card",{selected:((ae=g.value)==null?void 0:ae.id)===U.id}]),onClick:ce=>ie(U)},[C("div",Kl,[E.value[U.id]?(I(),A("img",{key:0,src:E.value[U.id],alt:"图片预览",class:"thumbnail-image"},null,8,Zl)):(I(),A("div",Xl,"加载中...")),C("div",{class:"thumbnail-overlay",onClick:pl(ce=>f(U.id),["stop"])},[C("span",null,[l(e(ee),null,{default:a(()=>[l(e(je))]),_:1}),n[9]||(n[9]=b(" 点击查看大图"))])],8,ea)]),C("div",la,[C("span",aa,G(de(U.fileType)),1),C("span",ta,G((U.fileSize/1024).toFixed(0))+" KB",1)])],10,Hl)}),128))],512),T.value?(I(),A("div",{key:1,class:Ve(["gallery-arrow gallery-arrow-right",{disabled:J.value}]),onClick:n[2]||(n[2]=U=>v("right"))},[l(e(ee),{size:24},{default:a(()=>[l(e(Me))]),_:1})],2)):re("",!0)])):g.value&&ue(g.value.fileType)?(I(),A("div",oa,[C("div",ra,[l(e(We),null,{default:a(()=>[l(e(M),{type:"primary",plain:"",size:"small",onClick:t,disabled:D.value<=1},{default:a(()=>[l(e(ee),null,{default:a(()=>[l(e(Ae))]),_:1}),n[10]||(n[10]=b(" 上一页 "))]),_:1},8,["disabled"]),l(e(M),{type:"primary",plain:"",size:"small"},{default:a(()=>[b(G(D.value)+" / "+G(R.value),1)]),_:1}),l(e(M),{type:"primary",plain:"",size:"small",onClick:o,disabled:D.value>=R.value},{default:a(()=>[n[11]||(n[11]=b(" 下一页 ")),l(e(ee),null,{default:a(()=>[l(e(Me))]),_:1})]),_:1},8,["disabled"])]),_:1}),l(e(We),null,{default:a(()=>[l(e(M),{type:"primary",plain:"",size:"small",onClick:_,disabled:x.value<=.5},{default:a(()=>[l(e(ee),null,{default:a(()=>[l(e(il))]),_:1})]),_:1},8,["disabled"]),l(e(M),{type:"primary",plain:"",size:"small",onClick:w,disabled:x.value>=2},{default:a(()=>[l(e(ee),null,{default:a(()=>[l(e(je))]),_:1})]),_:1},8,["disabled"])]),_:1}),l(e(M),{type:"primary",link:"",size:"small",onClick:n[3]||(n[3]=U=>X(g.value))},{default:a(()=>[l(e(ee),null,{default:a(()=>[l(e(Ue))]),_:1}),n[12]||(n[12]=b(" 下载PDF "))]),_:1})]),C("div",na,[C("canvas",{ref_key:"pdfCanvas",ref:m,class:"pdf-canvas"},null,512)]),N.value?(I(),A("div",sa,[l(e(ee),{class:"is-loading"},{default:a(()=>[l(e(dl))]),_:1}),n[13]||(n[13]=C("span",null,"加载PDF中...",-1))])):re("",!0)])):g.value?(I(),A("div",ia,[C("div",da,[l(e(ee),{size:32},{default:a(()=>[l(e(Ge))]),_:1})]),C("div",ua,[C("div",ca,G(de(g.value.fileType)),1),l(e(ul),{type:"primary",onClick:n[4]||(n[4]=U=>X(g.value)),underline:!1,class:"action-link"},{default:a(()=>[n[14]||(n[14]=b(" 下载后查看 ")),l(e(ee),{class:"el-icon--right"},{default:a(()=>[l(e(Ue))]),_:1})]),_:1})])])):re("",!0)])])):re("",!0)])),[[j,P.value]]),L.value?(I(),K(e(cl),{key:0,"url-list":z.value,"initial-index":B.value,"hide-on-click-modal":!0,onClose:n[5]||(n[5]=U=>L.value=!1)},null,8,["url-list","initial-index"])):re("",!0)]),_:1},8,["modelValue"])}}}),fa=Te(ma,[["__scopeId","data-v-d2b28cc6"]]),va={class:"dialog-footer"},ga=xe({__name:"ExportOptionsDialog",emits:["export-started"],setup(F,{expose:S,emit:$}){const P=p([{label:"文档 ID",value:"id"},{label:"文档名称",value:"docName"},{label:"文档类型",value:"docTypeName"},{label:"来源部门",value:"sourceDepartmentName"},{label:"提交人",value:"submitter"},{label:"接收人",value:"receiver"},{label:"签收（章）人",value:"signer"},{label:"交接日期",value:"handoverDate"},{label:"保管位置",value:"storageLocation"},{label:"备注",value:"remarks"},{label:"创建人",value:"createdByName"},{label:"创建时间",value:"createdAt"},{label:"最后修改人",value:"updatedByName"},{label:"最后修改时间",value:"updatedAt"}]),W=p(!1),V=p(!1),g=p([]),Y=p("xlsx"),i=p("all"),E=p(null),L=p([]),B=p([]),z=$,O=te(()=>L.value.length>0),le=te(()=>L.value.length),m=te(()=>B.value.length>0),N=te(()=>B.value.length),d=(q,y=[],T=[])=>{console.log("[Debug] ExportOptionsDialog: Received selectedItemIds:",y),console.log("[Debug] ExportOptionsDialog: Received currentPageIds:",T),E.value=q,L.value=y,B.value=T,g.value=P.value.map(Q=>Q.value),y.length>0?i.value="selected":T.length>0?i.value="currentPage":i.value="all",W.value=!0},D=()=>{V.value||(W.value=!1)},R=async()=>{var q,y;if(!g.value.length){h.warning("请至少选择一个要导出的字段");return}if(i.value==="selected"&&!O.value){h.warning("请先在表格中勾选要导出的文档");return}if(i.value==="currentPage"&&!m.value){h.warning("当前页没有可导出的数据");return}V.value=!0;try{const T={fields:g.value,fileType:Y.value,exportScope:i.value};if(i.value==="all"&&E.value){const J=E.value,Z={},se=["docName","submitter","receiver","docTypeId","sourceDepartmentId","docTypeNameFilter","sourceDepartmentNameFilter","signer"];for(const X of se)J[X]!==null&&J[X]!==void 0&&J[X]!==""&&(Z[X]=J[X]);J.handoverDateRange&&Array.isArray(J.handoverDateRange)&&J.handoverDateRange.length===2&&(Z.handoverDateStart=J.handoverDateRange[0],Z.handoverDateEnd=J.handoverDateRange[1]),Z.docTypeNameFilter===""&&delete Z.docTypeNameFilter,Z.sourceDepartmentNameFilter===""&&delete Z.sourceDepartmentNameFilter,Object.keys(Z).length>0&&(T.query=Z)}else i.value==="selected"?T.selectedIds=L.value:i.value==="currentPage"&&(T.currentPageIds=B.value);console.log("[Debug] Export Request Params:",JSON.stringify(T));const Q=await Tl(T);Q&&typeof Q.taskId=="number"?(console.log("[Debug] handleSubmit: Success path executing."),h.success('导出任务已创建，请稍后在"导出任务"页面查看进度和下载。'),z("export-started",Q.taskId),D()):(console.error("Invalid payload structure received after creating export task:",Q),console.log("[Debug] handleSubmit: Invalid payload structure path executing."),h.error("创建导出任务失败：响应数据异常"))}catch(T){console.error("Request export error:",T);const Q=((y=(q=T==null?void 0:T.response)==null?void 0:q.data)==null?void 0:y.message)||(T==null?void 0:T.message)||"创建导出任务时发生错误";console.log("[Debug] handleSubmit: Catch block executing."),h.error(Q)}finally{V.value=!1}},x=()=>{g.value=P.value.map(q=>q.value)},k=()=>{g.value=[]};return S({open:d}),(q,y)=>(I(),K(e(Ne),{modelValue:W.value,"onUpdate:modelValue":y[3]||(y[3]=T=>W.value=T),title:"导出选项",width:"650px","close-on-click-modal":!1,onClose:D},{footer:a(()=>[C("span",va,[l(e(M),{onClick:D},{default:a(()=>y[9]||(y[9]=[b("取消")])),_:1}),l(e(M),{type:"primary",onClick:R,loading:V.value},{default:a(()=>y[10]||(y[10]=[b(" 确认导出 ")])),_:1},8,["loading"])])]),default:a(()=>[l(e(Le),{"label-width":"100px"},{default:a(()=>[l(e($e),{label:"导出范围"},{default:a(()=>[l(e(qe),{modelValue:i.value,"onUpdate:modelValue":y[0]||(y[0]=T=>i.value=T)},{default:a(()=>[l(e(_e),{label:"all"},{default:a(()=>y[4]||(y[4]=[b("全部 (根据筛选条件)")])),_:1}),l(e(_e),{label:"currentPage",disabled:!m.value},{default:a(()=>[b(" 当前页 ("+G(N.value)+" 项) ",1)]),_:1},8,["disabled"]),l(e(_e),{label:"selected",disabled:!O.value},{default:a(()=>[b(" 选中项 ("+G(le.value)+" 项) ",1)]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),l(e($e),{label:"选择字段"},{default:a(()=>[l(e(he),{gutter:10,style:{width:"100%","margin-bottom":"10px"}},{default:a(()=>[l(e(oe),{span:12},{default:a(()=>[l(e(M),{type:"primary",link:"",onClick:x},{default:a(()=>y[5]||(y[5]=[b("全选")])),_:1}),l(e(M),{type:"primary",link:"",onClick:k,style:{"margin-left":"15px"}},{default:a(()=>y[6]||(y[6]=[b("取消全选")])),_:1})]),_:1})]),_:1}),l(e(ml),{modelValue:g.value,"onUpdate:modelValue":y[1]||(y[1]=T=>g.value=T)},{default:a(()=>[l(e(he),{gutter:5,style:{width:"100%"}},{default:a(()=>[(I(!0),A(ke,null,Pe(P.value,T=>(I(),K(e(oe),{span:8,key:T.value},{default:a(()=>[l(e(fl),{label:T.value,style:{"margin-bottom":"8px"}},{default:a(()=>[b(G(T.label),1)]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(e($e),{label:"文件类型"},{default:a(()=>[l(e(qe),{modelValue:Y.value,"onUpdate:modelValue":y[2]||(y[2]=T=>Y.value=T)},{default:a(()=>[l(e(_e),{label:"xlsx"},{default:a(()=>y[7]||(y[7]=[b("Excel (.xlsx)")])),_:1}),l(e(_e),{label:"csv"},{default:a(()=>y[8]||(y[8]=[b("CSV (.csv)")])),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),ya=Te(ga,[["__scopeId","data-v-8a0226dc"]]),ba={class:"import-dialog-content"},ha={class:"dialog-footer"},Da=xe({__name:"ImportDialog",setup(F,{expose:S}){const $=p(!1),P=p(null),W=p(null),V=p(!1),Y="http://localhost:3000/api/v1/upload/excel",i=te(()=>{const d=localStorage.getItem("authToken");return console.log("[ImportDialog] Token from localStorage:",d?"found":"not found"),d?{Authorization:`Bearer ${d}`}:{}}),E=async()=>{console.log("[ImportDialog] open method called."),console.log("[ImportDialog] Current dialogVisible state before change:",$.value);try{B(),$.value=!0,console.log("[ImportDialog] dialogVisible set to true. Waiting for nextTick..."),await be(),console.log("[ImportDialog] After nextTick. Dialog should now be visible in the DOM."),console.log("[ImportDialog] Final dialogVisible state:",$.value)}catch(d){console.error("[ImportDialog] Error occurred within the open method:",d)}},L=()=>{if(V.value){h.warning("文件正在上传中，请稍候...");return}B(),$.value=!1},B=()=>{var d;W.value=null,(d=P.value)==null||d.clearFiles(),V.value=!1},z=(d,D)=>{var R;console.log("[ImportDialog File Change] File status:",d.name,d.status),D.length>0?(W.value=D[D.length-1],d.status==="fail"&&(W.value=null,(R=P.value)==null||R.clearFiles())):W.value=null},O=d=>{console.log("[ImportDialog Before Upload] File:",d.name);const D=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],R=50,x=R*1024*1024,k=D.includes(d.type)||d.name.endsWith(".xls")||d.name.endsWith(".xlsx"),q=d.size<=x;return k?q?!0:(h.error(`文件大小不能超过 ${R}MB!`),!1):(h.error("文件类型错误，请上传 Excel 文件 (.xls, .xlsx)"),!1)},le=()=>{var d;if(!W.value){h.warning("请先选择一个 Excel 文件");return}V.value||(console.log("[ImportDialog Manual Upload] Triggering submit..."),V.value=!0,(d=P.value)==null||d.submit())},m=(d,D,R)=>{if(console.log("[ImportDialog Upload Success] Response:",d),V.value=!1,d&&d.code===201&&d.data){h.success(d.message||"文件上传成功，导入任务已创建"),L();return}if(d&&typeof d.fileName=="string"&&typeof d.originalName=="string"){h.info("文件上传成功，正在请求后台处理导入任务...");const x={fileName:d.fileName,originalName:d.originalName};Il(x).then(k=>{(k==null?void 0:k.code)===200?(h.success("后台导入任务已创建！"),L()):h.error((k==null?void 0:k.message)||"触发导入任务失败")}).catch(k=>{var y,T;console.error("[ImportDialog Request Import] API Call Failed:",k);const q=((T=(y=k.response)==null?void 0:y.data)==null?void 0:T.message)||k.message||"请求触发导入任务时出错";h.error(`触发导入任务失败: ${q}`)})}else console.error("[ImportDialog Upload Success] Invalid upload response:",d),h.error((d==null?void 0:d.message)||"文件上传接口响应异常")},N=(d,D,R)=>{console.error("[ImportDialog Upload Error] Raw Error:",d),V.value=!1;let x="文件上传失败";try{if(d.response&&d.response.data)x=d.response.data.message||`上传失败，状态码：${d.response.status}`;else if(d.message)try{const k=JSON.parse(d.message);x=k.message?`文件上传失败: ${k.message}`:`文件上传失败: ${d.message}`}catch{x=`文件上传失败: ${d.message}`}}catch(k){console.error("[ImportDialog Upload Error] Parse error failed:",k)}h.error(x)};return S({open:E}),(d,D)=>(I(),K(e(Ne),{modelValue:$.value,"onUpdate:modelValue":D[0]||(D[0]=R=>$.value=R),title:"批量导入文档",width:"600px",modal:!0,"append-to-body":!0,onClose:L,"close-on-click-modal":!V.value,"close-on-press-escape":!V.value,onClosed:B},{footer:a(()=>[C("span",ha,[l(e(M),{onClick:L,disabled:V.value},{default:a(()=>D[3]||(D[3]=[b("取消")])),_:1},8,["disabled"]),l(e(M),{type:"primary",onClick:le,loading:V.value},{default:a(()=>[b(G(V.value?"上传中...":"确定上传并导入"),1)]),_:1},8,["loading"])])]),default:a(()=>[C("div",ba,[l(e(Ke),{ref_key:"uploadRef",ref:P,class:"upload-importer",drag:"",action:Y,headers:i.value,limit:1,"auto-upload":!1,"on-change":z,"before-upload":O,"on-success":m,"on-error":N,accept:".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"},{tip:a(()=>D[1]||(D[1]=[C("div",{class:"el-upload__tip"},[b(" 请上传 .xls 或 .xlsx 格式的 Excel 文件，大小不超过 50MB。"),C("br"),b(" 文件需要包含以下列：文档名称, 提交人, 接收人, [可选列: 文档类型, 来源部门, 签收人, 交接日期, 存放位置, 备注] ")],-1)])),default:a(()=>[l(e(ee),{class:"el-icon--upload"},{default:a(()=>[l(e(el))]),_:1}),D[2]||(D[2]=C("div",{class:"el-upload__text"},[b(" 将 Excel 文件拖到此处，或"),C("em",null,"点击选择")],-1))]),_:1},8,["headers"])])]),_:1},8,["modelValue","close-on-click-modal","close-on-press-escape"]))}}),wa=Te(Da,[["__scopeId","data-v-1cbb28d7"]]),_a={class:"document-list-view"},ka={class:"filter-group"},xa={class:"filter-group"},Ta={class:"toolbar"},Ia={class:"toolbar-buttons"},Va=xe({__name:"DocumentListView",setup(F){const S=p(),$=p(null),P=p(null),W=p(null),V=p(null),g=p(),Y=p([]),i=Ce({docName:"",submitter:"",receiver:"",docTypeId:null,sourceDepartmentId:null,docTypeNameFilter:"",sourceDepartmentNameFilter:"",signer:"",handoverDateRange:null,page:1,pageSize:10}),E=p([]),L=p(!1),B=p(!1),z=Ce({page:1,pageSize:10,total:0}),O=p([]),le=p([]),m={value:"id",label:"name",children:"children"},N=async u=>{var s,o,t,w;L.value=!0;try{const _={page:z.page,pageSize:z.pageSize,docName:i.docName||void 0,submitter:i.submitter||void 0,receiver:i.receiver||void 0,docTypeId:i.docTypeId??void 0,docTypeNameFilter:i.docTypeId?void 0:i.docTypeNameFilter||void 0,sourceDepartmentId:i.sourceDepartmentId??void 0,sourceDepartmentNameFilter:i.sourceDepartmentId?void 0:i.sourceDepartmentNameFilter||void 0,signer:i.signer||void 0,handoverDateStart:((s=i.handoverDateRange)==null?void 0:s[0])||void 0,handoverDateEnd:((o=i.handoverDateRange)==null?void 0:o[1])||void 0,sortField:u==null?void 0:u.prop,sortOrder:(u==null?void 0:u.order)==="descending"?"DESC":(u==null?void 0:u.order)==="ascending"?"ASC":void 0};Object.keys(_).forEach(c=>{const v=c;(_[v]===void 0||_[v]===null||_[v]==="")&&delete _[v]});const f=await Cl(_);console.log("[DocumentListView] Raw response from getDocuments service:",f),f&&Array.isArray(f.list)&&typeof f.total=="number"?(console.log("[DocumentListView] Trying to extract from result directly"),E.value=f.list,z.total=f.total):(console.error("Invalid data structure received from getDocuments:",f),h.error("获取文档列表失败：数据格式错误"),E.value=[],z.total=0)}catch(_){console.error("Fetch documents error:",_);const f=((w=(t=_==null?void 0:_.response)==null?void 0:t.data)==null?void 0:w.message)||(_==null?void 0:_.message)||"获取文档列表时发生错误";h.error(f),E.value=[],z.total=0}finally{L.value=!1}},d=async()=>{B.value=!0;try{O.value=await xl()}catch(u){console.error("Error fetching document type tree:",u),h.error("获取文档类型失败")}finally{B.value=!1}},D=async()=>{B.value=!0;try{le.value=await vl()}catch(u){console.error("Error fetching department tree:",u),h.error("获取部门失败")}finally{B.value=!1}},R=()=>{z.page=1,N()},x=()=>{var u;(u=S.value)==null||u.resetFields(),i.docTypeId=null,i.sourceDepartmentId=null,i.docTypeNameFilter="",i.sourceDepartmentNameFilter="",i.handoverDateRange=null,i.docName="",i.submitter="",i.receiver="",i.signer="",R()},k=u=>{const{prop:s,order:o}=u;s&&o?N({prop:s,order:o}):N()},q=u=>{N()},y=u=>{N()},T=()=>{var u;(u=$.value)==null||u.open("add")},Q=u=>{var s;(s=$.value)==null||s.open("view",u)},J=u=>{var s;(s=$.value)==null||s.open("edit",u)},Z=async u=>{if(typeof u.id!="number"){h.error("无法删除：文档 ID 无效");return}try{await Ze.confirm(`确定要删除文档 "${u.docName||"未知名称"}" 吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),L.value=!0,await Nl(u.id),h.success(`删除文档 "${u.docName||"未知名称"}" 成功`),N()}catch(s){s!=="cancel"&&(console.error("删除文档失败:",s),h.error(`删除文档失败: ${(s==null?void 0:s.message)||"未知错误"}`))}finally{L.value=!1}},se=u=>{Y.value=u.map(s=>s.id).filter(s=>typeof s=="number"),console.log("[Debug] DocumentListView: Selection changed, selected IDs:",Y.value)},X=()=>{if(W.value){const u=E.value.map(s=>s.id).filter(s=>typeof s=="number");W.value.open(i,Y.value,u)}},de=async()=>{if(console.log("[DocumentListView] handleImportClick called"),!V.value){console.error("[DocumentListView] Import dialog reference is null"),h.error("导入对话框组件未正确加载，请刷新页面重试");return}try{console.log("[DocumentListView] Opening import dialog..."),await V.value.open(),console.log("[DocumentListView] Import dialog opened successfully.")}catch(u){console.error("[DocumentListView] Error opening import dialog:",u),h.error("打开导入对话框时发生错误，请刷新页面重试")}},me=(u,s=!1)=>{if(!u)return"-";try{const o=new Date(u);if(isNaN(o.getTime()))return"-";const t=o.getFullYear(),w=(o.getMonth()+1).toString().padStart(2,"0"),_=o.getDate().toString().padStart(2,"0");if(s)return`${t}-${w}-${_}`;const f=o.getHours().toString().padStart(2,"0"),c=o.getMinutes().toString().padStart(2,"0"),v=o.getSeconds().toString().padStart(2,"0");return`${t}-${w}-${_} ${f}:${c}:${v}`}catch(o){return console.error("Error formatting date:",u,o),"-"}},fe=u=>me(u,!0),ve=u=>me(u);Xe(()=>{console.log("[DocumentListView] onMounted STARTING..."),d(),D(),N()});const ue=u=>{u!==null&&(i.docTypeNameFilter="")},ie=u=>{u&&(i.docTypeId=null)},ge=u=>{u!==null&&(i.sourceDepartmentNameFilter="")},De=u=>{u&&(i.sourceDepartmentId=null)},we=u=>{var s;u.id?(s=P.value)==null||s.open(u.id):h.error("无法预览附件：无效的文档ID。")};return(u,s)=>{const o=pe("el-form-item"),t=pe("el-date-picker"),w=pe("el-button"),_=pe("el-card"),f=pe("el-table-column"),c=Re("loading");return I(),A("div",_a,[l(_,{class:"search-card",shadow:"never"},{default:a(()=>[l(e(Le),{model:i,ref_key:"searchFormRef",ref:S,"label-width":"70px",class:"search-form"},{default:a(()=>[l(o,{label:"文档名称",prop:"docName"},{default:a(()=>[l(e(H),{modelValue:i.docName,"onUpdate:modelValue":s[0]||(s[0]=v=>i.docName=v),placeholder:"输入文档名称",clearable:"",style:{width:"220px"}},null,8,["modelValue"])]),_:1}),l(o,{label:"提交人",prop:"submitter"},{default:a(()=>[l(e(H),{modelValue:i.submitter,"onUpdate:modelValue":s[1]||(s[1]=v=>i.submitter=v),placeholder:"输入提交人",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),l(o,{label:"接收人",prop:"receiver"},{default:a(()=>[l(e(H),{modelValue:i.receiver,"onUpdate:modelValue":s[2]||(s[2]=v=>i.receiver=v),placeholder:"输入接收人",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),l(o,{label:"文档类型",prop:"docTypeId"},{default:a(()=>[C("div",ka,[l(e(Fe),{modelValue:i.docTypeId,"onUpdate:modelValue":s[3]||(s[3]=v=>i.docTypeId=v),placeholder:"选择精确类型",data:O.value,props:m,"check-strictly":"","render-after-expand":!1,clearable:"",loading:B.value,style:{width:"180px"},onChange:ue},null,8,["modelValue","data","loading"]),l(e(H),{modelValue:i.docTypeNameFilter,"onUpdate:modelValue":s[4]||(s[4]=v=>i.docTypeNameFilter=v),placeholder:"或输入模糊类型",clearable:"",style:{width:"150px"},onInput:ie,onClear:s[5]||(s[5]=()=>{i.docTypeNameFilter=""})},null,8,["modelValue"])])]),_:1}),l(o,{label:"来源部门",prop:"sourceDepartmentId"},{default:a(()=>[C("div",xa,[l(e(Fe),{modelValue:i.sourceDepartmentId,"onUpdate:modelValue":s[6]||(s[6]=v=>i.sourceDepartmentId=v),placeholder:"选择精确部门",data:le.value,props:m,"check-strictly":"","render-after-expand":!1,clearable:"",loading:B.value,style:{width:"180px"},onChange:ge},null,8,["modelValue","data","loading"]),l(e(H),{modelValue:i.sourceDepartmentNameFilter,"onUpdate:modelValue":s[7]||(s[7]=v=>i.sourceDepartmentNameFilter=v),placeholder:"或输入模糊部门",clearable:"",style:{width:"150px"},onInput:De,onClear:s[8]||(s[8]=()=>{i.sourceDepartmentNameFilter=""})},null,8,["modelValue"])])]),_:1}),l(o,{label:"签章人",prop:"signer"},{default:a(()=>[l(e(H),{modelValue:i.signer,"onUpdate:modelValue":s[9]||(s[9]=v=>i.signer=v),placeholder:"签章人",clearable:"",style:{width:"120px"}},null,8,["modelValue"])]),_:1}),l(o,{label:"交接日期",prop:"handoverDateRange"},{default:a(()=>[l(t,{modelValue:i.handoverDateRange,"onUpdate:modelValue":s[10]||(s[10]=v=>i.handoverDateRange=v),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"220px"}},null,8,["modelValue"])]),_:1}),l(o,{label:"",class:"search-buttons"},{default:a(()=>[l(w,{type:"primary",onClick:R,icon:e(gl)},{default:a(()=>s[13]||(s[13]=[b("搜索")])),_:1},8,["icon"]),l(w,{onClick:x,icon:e(yl)},{default:a(()=>s[14]||(s[14]=[b("重置")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),l(_,{class:"table-card",shadow:"never"},{default:a(()=>[C("div",Ta,[C("div",Ia,[l(w,{type:"primary",onClick:T,icon:e(bl)},{default:a(()=>s[15]||(s[15]=[b("新增文档")])),_:1},8,["icon"]),l(w,{type:"success",onClick:de,icon:e(el)},{default:a(()=>s[16]||(s[16]=[b("批量导入")])),_:1},8,["icon"]),l(w,{type:"warning",onClick:X,icon:e(Ue),style:{"margin-left":"10px"}},{default:a(()=>s[17]||(s[17]=[b("批量导出")])),_:1},8,["icon"])])]),Ee((I(),K(e(Qe),{ref_key:"tableRef",ref:g,data:E.value,style:{width:"100%"},stripe:"",border:"",onSortChange:k,"default-sort":{prop:"createdAt",order:"descending"},onSelectionChange:se,"row-key":"id"},{default:a(()=>[l(f,{type:"selection",width:"45","reserve-selection":!0}),l(f,{prop:"id",label:"ID",width:"70",sortable:""}),l(f,{prop:"docName",label:"文档名称",width:"355","show-overflow-tooltip":""}),l(f,{prop:"docTypeName",label:"文档类型",width:"120","show-overflow-tooltip":""}),l(f,{prop:"departmentName",label:"来源部门",width:"120","show-overflow-tooltip":""}),l(f,{prop:"submitter",label:"提交人",width:"90"}),l(f,{prop:"receiver",label:"接收人",width:"90"}),l(f,{prop:"signer",label:"签章人",width:"90"}),l(f,{prop:"handoverDate",label:"交接日期",width:"110",align:"center",sortable:"custom"},{default:a(({row:v})=>[b(G(fe(v.handoverDate)),1)]),_:1}),l(f,{prop:"createdBy",label:"创建人",width:"90"}),l(f,{prop:"createdAt",label:"创建时间",width:"200",align:"center",sortable:"custom"},{default:a(({row:v})=>[b(G(ve(v.createdAt)),1)]),_:1}),l(f,{label:"操作",width:"260",align:"center",fixed:"right"},{default:a(({row:v})=>[l(w,{type:"primary",link:"",size:"small",icon:e(hl),onClick:r=>Q(v)},{default:a(()=>s[18]||(s[18]=[b("查看")])),_:2},1032,["icon","onClick"]),l(w,{type:"primary",link:"",size:"small",icon:e(Dl),onClick:r=>J(v)},{default:a(()=>s[19]||(s[19]=[b("编辑")])),_:2},1032,["icon","onClick"]),l(w,{type:"success",link:"",size:"small",icon:e(wl),onClick:r=>we(v),disabled:!v.fileCount||v.fileCount===0},{default:a(()=>s[20]||(s[20]=[b("预览文件")])),_:2},1032,["icon","onClick","disabled"]),l(w,{type:"danger",link:"",size:"small",icon:e(_l),onClick:r=>Z(v)},{default:a(()=>s[21]||(s[21]=[b("删除")])),_:2},1032,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[c,L.value]]),l(e(kl),{class:"pagination-container","current-page":z.page,"onUpdate:currentPage":s[11]||(s[11]=v=>z.page=v),"page-size":z.pageSize,"onUpdate:pageSize":s[12]||(s[12]=v=>z.pageSize=v),"page-sizes":[10,20,50,100],total:z.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:q,onCurrentChange:y},null,8,["current-page","page-size","total"])]),_:1}),l(Wl,{ref_key:"documentFormDialogRef",ref:$,"doc-type-tree-data":O.value,"department-tree-data":le.value,onSuccess:N},null,8,["doc-type-tree-data","department-tree-data"]),l(fa,{ref_key:"documentFileViewDialogRef",ref:P},null,512),l(ya,{ref_key:"exportOptionsDialogRef",ref:W},null,512),l(wa,{ref_key:"importDialogRef",ref:V},null,512)])}}}),Na=Te(Va,[["__scopeId","data-v-fa3f063e"]]);export{Na as default};
