import{g as I,d as J}from"./task-DdUqF9WL.js";import{al as L,d as X,r as z,l as K,o as Q,a as W,e as m,f as l,g as r,h as C,u as D,q as Y,E as V,i,b as Z,p as R,v as ee,c as te,j as A,t as k,k as w,a7 as q,am as ae,C as M,_ as oe}from"./index-BRnZ6Wrp.js";var P={exports:{}};(function(H,x){(function(S,y){y()})(L,function(){function S(a,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function y(a,o,v){var n=new XMLHttpRequest;n.open("GET",a),n.responseType="blob",n.onload=function(){g(n.response,o,v)},n.onerror=function(){console.error("could not download file")},n.send()}function b(a){var o=new XMLHttpRequest;o.open("HEAD",a,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function _(a){try{a.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(o)}}var c=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof L=="object"&&L.global===L?L:void 0,h=c.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),g=c.saveAs||(typeof window!="object"||window!==c?function(){}:"download"in HTMLAnchorElement.prototype&&!h?function(a,o,v){var n=c.URL||c.webkitURL,f=document.createElement("a");o=o||a.name||"download",f.download=o,f.rel="noopener",typeof a=="string"?(f.href=a,f.origin===location.origin?_(f):b(f.href)?y(a,o,v):_(f,f.target="_blank")):(f.href=n.createObjectURL(a),setTimeout(function(){n.revokeObjectURL(f.href)},4e4),setTimeout(function(){_(f)},0))}:"msSaveOrOpenBlob"in navigator?function(a,o,v){if(o=o||a.name||"download",typeof a!="string")navigator.msSaveOrOpenBlob(S(a,v),o);else if(b(a))y(a,o,v);else{var n=document.createElement("a");n.href=a,n.target="_blank",setTimeout(function(){_(n)})}}:function(a,o,v,n){if(n=n||open("","_blank"),n&&(n.document.title=n.document.body.innerText="downloading..."),typeof a=="string")return y(a,o,v);var f=a.type==="application/octet-stream",B=/constructor/i.test(c.HTMLElement)||c.safari,E=/CriOS\/[\d]+/.test(navigator.userAgent);if((E||f&&B||h)&&typeof FileReader<"u"){var j=new FileReader;j.onloadend=function(){var e=j.result;e=E?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=e:location=e,n=null},j.readAsDataURL(a)}else{var U=c.URL||c.webkitURL,s=U.createObjectURL(a);n?n.location=s:location.href=s,n=null,setTimeout(function(){U.revokeObjectURL(s)},4e4)}});c.saveAs=g.saveAs=g,H.exports=g})})(P);var se=P.exports;const ne={class:"export-task-list-view"},re={class:"card-header"},le={class:"filter-controls"},ie={key:1},ue={key:0},de={key:1},pe={key:0,style:{color:"#67C23A"}},ce={key:1},fe={key:1},me={key:1},ge={key:2},ve={key:3},ye={key:4},_e={key:1},he={key:2},we={key:1},ke={style:{"max-height":"70vh","overflow-y":"auto"}},be={style:{"white-space":"pre-wrap","word-wrap":"break-word"}},Te={class:"dialog-footer"},xe=X({__name:"ExportTaskList",setup(H){const x=z("document_export"),S=z(!1),y=z(""),b=z([]),_=z(0),c=z(!1),h=K({page:1,pageSize:10});let g=null;const a=async()=>{var s,e;c.value=!0;try{const d={...h,taskType:x.value==="all"?void 0:x.value},u=await I(d);if(u&&Array.isArray(u.list)&&typeof u.total=="number"){b.value=u.list.map(T=>({...T,downloading:!1})),_.value=u.total;const p=b.value.some(T=>T.status===0||T.status===1);p&&!g?B():!p&&g&&E()}else console.error("Invalid data structure received from getTasks:",u),V.error("获取任务列表失败：数据格式错误"),b.value=[],_.value=0}catch(d){console.error("Fetch tasks error:",d);const u=((e=(s=d==null?void 0:d.response)==null?void 0:s.data)==null?void 0:e.message)||(d==null?void 0:d.message)||"获取任务列表时发生错误";V.error(u),b.value=[],_.value=0}finally{c.value=!1}},o=async s=>{if(s.id){s.downloading=!0;try{const e=await J(s.id);se.saveAs(e,s.fileName||`export_${s.id}.${s.fileType||"xlsx"}`)}catch(e){console.error("Download file error:",e),V.error("下载文件失败，请稍后重试或检查任务状态。")}finally{s.downloading=!1}}},v=s=>{switch(s){case 0:return"排队中";case 1:return"处理中";case 2:return"已完成";case 3:return"失败";default:return"未知"}},n=s=>{switch(s){case 0:return"primary";case 1:return"warning";case 2:return"success";case 3:return"danger";default:return"info"}},f=(s,e,d)=>{if(!d)return"";try{const u=new Date(d),p=u.getFullYear(),T=(u.getMonth()+1).toString().padStart(2,"0"),O=u.getDate().toString().padStart(2,"0"),$=u.getHours().toString().padStart(2,"0"),N=u.getMinutes().toString().padStart(2,"0");return`${p}-${T}-${O} ${$}:${N}`}catch{return""}},B=()=>{g||(g=window.setInterval(()=>{console.log("Auto refreshing tasks...");const s={page:h.page,pageSize:h.pageSize,taskType:x.value==="all"?void 0:x.value};I(s).then(e=>{e&&Array.isArray(e.list)&&(e.list.some(u=>u.status===0||u.status===1)||E(),a())}).catch(e=>{console.error("Auto refresh error:",e),E()})},5e3))},E=()=>{g&&(clearInterval(g),g=null,console.log("Stopped auto refreshing tasks."))},j=s=>{switch(s){case"document_export":return"文档导出";case"document_import":return"文档导入";default:return"未知类型"}},U=s=>{if(s.errorDetails)try{const e=JSON.parse(s.errorDetails);y.value=JSON.stringify(e,null,2)}catch{y.value=s.errorDetails}else y.value="没有可用的错误详情。";S.value=!0};return Q(()=>{a()}),W(()=>{E()}),(s,e)=>{const d=C("el-radio-button"),u=C("el-radio-group"),p=C("el-table-column"),T=C("el-progress"),O=C("el-table"),$=C("el-pagination"),N=C("el-card"),G=te("loading");return i(),m("div",ne,[l(N,{shadow:"never"},{header:r(()=>[A("div",re,[e[9]||(e[9]=A("span",null,"我的后台任务",-1)),A("div",le,[l(u,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=t=>x.value=t),onChange:a,size:"small"},{default:r(()=>[l(d,{label:"all"},{default:r(()=>e[5]||(e[5]=[w("所有任务")])),_:1}),l(d,{label:"document_export"},{default:r(()=>e[6]||(e[6]=[w("文档导出")])),_:1}),l(d,{label:"document_import"},{default:r(()=>e[7]||(e[7]=[w("文档导入")])),_:1})]),_:1},8,["modelValue"]),l(D(M),{type:"primary",icon:"Refresh",onClick:a,loading:c.value,style:{"margin-left":"10px"}},{default:r(()=>e[8]||(e[8]=[w("刷新")])),_:1},8,["loading"])])])]),default:r(()=>[Z((i(),R(O,{data:b.value,style:{width:"100%"}},{default:r(()=>[l(p,{prop:"taskType",label:"任务类型",width:"120"},{default:r(({row:t})=>[A("span",null,k(j(t.taskType)),1)]),_:1}),l(p,{prop:"id",label:"任务 ID",width:"100"}),l(p,{prop:"fileName",label:"文件名/源","min-width":"180","show-overflow-tooltip":""},{default:r(({row:t})=>[w(k(t.fileName||t.originalFileName||"-"),1)]),_:1}),l(p,{prop:"fileType",label:"文件类型",width:"100"},{default:r(({row:t})=>[t.fileType?(i(),R(D(q),{key:0,type:t.fileType==="xlsx"?"success":"primary",size:"small"},{default:r(()=>{var F;return[w(k((F=t.fileType)==null?void 0:F.toUpperCase()),1)]}),_:2},1032,["type"])):(i(),m("span",ie,"-"))]),_:1}),l(p,{prop:"status",label:"状态",width:"120"},{default:r(({row:t})=>[l(D(q),{type:n(t.status),size:"small"},{default:r(()=>[w(k(v(t.status)),1)]),_:2},1032,["type"])]),_:1}),l(p,{label:"总行数",width:"100",align:"center"},{default:r(({row:t})=>[t.taskType==="document_import"?(i(),m("span",ue,k(t.totalRows??"-"),1)):(i(),m("span",de,"-"))]),_:1}),l(p,{label:"成功数",width:"100",align:"center"},{default:r(({row:t})=>[t.taskType==="document_import"?(i(),m("span",pe,k(t.successCount??"-"),1)):(i(),m("span",ce,"-"))]),_:1}),l(p,{label:"失败数",width:"100",align:"center"},{default:r(({row:t})=>[t.taskType==="document_import"?(i(),m("span",{key:0,style:ae({color:t.failureCount>0?"#F56C6C":"#606266"})},k(t.failureCount??"-"),5)):(i(),m("span",fe,"-"))]),_:1}),l(p,{prop:"progress",label:"进度",width:"150"},{default:r(({row:t})=>[t.status===1?(i(),R(T,{key:0,percentage:t.progress||0,"stroke-width":8,striped:"","striped-flow":""},null,8,["percentage"])):t.status===2?(i(),m("span",me,"完成")):t.status===3?(i(),m("span",ge,"失败")):t.status===0?(i(),m("span",ve,"排队中")):(i(),m("span",ye,k(t.progress!==null?`${t.progress}%`:"-"),1))]),_:1}),l(p,{prop:"createdAt",label:"创建时间",width:"160",formatter:f,sortable:""}),l(p,{prop:"errorDetails",label:"错误信息","min-width":"150","show-overflow-tooltip":""},{default:r(({row:t})=>[t.status===3&&t.errorDetails?(i(),R(D(M),{key:0,type:"danger",link:"",size:"small",onClick:F=>U(t)},{default:r(()=>e[10]||(e[10]=[w("查看错误")])),_:2},1032,["onClick"])):t.status===3?(i(),m("span",_e,"未知错误")):(i(),m("span",he,"-"))]),_:1}),l(p,{label:"操作",width:"100",fixed:"right"},{default:r(({row:t})=>[t.taskType==="document_export"&&t.status===2&&t.filePath?(i(),R(D(M),{key:0,type:"primary",size:"small",link:"",onClick:F=>o(t),loading:t.downloading},{default:r(()=>e[11]||(e[11]=[w(" 下载 ")])),_:2},1032,["onClick","loading"])):(i(),m("span",we,"-"))]),_:1})]),_:1},8,["data"])),[[G,c.value]]),_.value>0?(i(),R($,{key:0,background:"",layout:"total, sizes, prev, pager, next, jumper",total:_.value,"current-page":h.page,"onUpdate:currentPage":e[1]||(e[1]=t=>h.page=t),"page-size":h.pageSize,"onUpdate:pageSize":e[2]||(e[2]=t=>h.pageSize=t),"page-sizes":[10,20,50,100],onSizeChange:a,onCurrentChange:a,class:"pagination-container"},null,8,["total","current-page","page-size"])):ee("",!0)]),_:1}),l(D(Y),{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),title:"错误详情",width:"60%",top:"5vh"},{footer:r(()=>[A("span",Te,[l(D(M),{onClick:e[3]||(e[3]=t=>S.value=!1)},{default:r(()=>e[12]||(e[12]=[w("关闭")])),_:1})])]),default:r(()=>[A("div",ke,[A("pre",be,k(y.value),1)])]),_:1},8,["modelValue"])])}}}),Ce=oe(xe,[["__scopeId","data-v-4ca82e6d"]]);export{Ce as default};
