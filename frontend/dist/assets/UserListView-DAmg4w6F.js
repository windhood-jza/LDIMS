import{w as E,d as W,r as _,l as F,p as N,g as s,h,n as H,i as U,f as e,s as G,e as X,O as Z,F as ee,j as B,k as y,E as w,_ as Y,o as ae,u as l,ak as J,ab as te,v as le,a4 as re,a5 as D,y as se,A as oe,ap as K,aq as z,z as I,ac as ne,ad as de,ae as ue,b as ie,c as me,G as k,H as pe,t as L,ar as ce,ag as fe,ai as ve,as as ge,D as we,aj as be,at as ye,au as _e,J as Q}from"./index-CnvRKQT5.js";const Ve=m=>E.get("/users",{params:m}),he=m=>E.post("/users",m),ke=m=>E.put(`/users/${m.id}`,m),Ue=m=>E.delete(`/users/${m}`),Ce=(m,p)=>E.patch(`/users/${m}/status`,{status:p}),xe=(m,p)=>E.post(`/users/${m}/reset-password`,p),Ie={class:"dialog-footer"},Ne=W({__name:"UserFormDialog",props:{departments:{}},emits:["success"],setup(m,{expose:p,emit:T}){const P=m,i=T,v=_(!1),g=_("add"),x=_(!1),c=_(),o=F({id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),q=F({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],realName:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],departmentId:[{required:!0,message:"请选择所属部门",trigger:"change"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],password:[{required:!0,message:"请输入密码",trigger:"blur",validator:(b,a,u)=>{var f;g.value==="add"&&!a?u(new Error("请输入密码")):(g.value==="add"&&o.confirmPassword&&((f=c.value)==null||f.validateField("confirmPassword")),u())}},{min:6,message:"密码长度不能小于 6 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:"blur",validator:(b,a,u)=>{g.value==="add"?a?a!==o.password?u(new Error("两次输入密码不一致")):u():u(new Error("请再次输入密码")):u()}}]}),M=(b,a)=>{g.value=b,v.value=!0,H(()=>{var u;(u=c.value)==null||u.clearValidate()}),b==="edit"&&a?Object.assign(o,{id:a.id,username:a.username,realName:a.realName,departmentId:a.departmentId,role:a.role,status:a.status,password:"",confirmPassword:""}):(Object.assign(o,{id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),H(()=>{var u,f;(u=c.value)==null||u.resetFields(["realName","departmentId","role","password","confirmPassword"]),g.value==="add"&&((f=c.value)==null||f.resetFields(["username"]))}))},S=()=>{v.value=!1,Object.assign(o,{id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),H(()=>{var b;(b=c.value)==null||b.resetFields()})},R=async()=>{c.value&&await c.value.validate(async b=>{if(b){x.value=!0;try{if(g.value==="add"){const a={username:o.username,realName:o.realName,departmentId:o.departmentId,role:o.role,status:Number(o.status),password:o.password};console.log("提交的创建数据:",a),await he(a),w.success("创建成功")}else{if(!o.id){w.error("无法更新用户：用户ID丢失"),x.value=!1;return}const a={id:o.id,realName:o.realName,departmentId:o.departmentId,role:o.role,status:Number(o.status)};console.log("提交的更新数据:",a),await ke(a),w.success("更新成功")}i("success"),S()}catch(a){console.error("表单提交错误:",a),w.error(a.message||"操作失败")}finally{x.value=!1}}})};return p({open:M}),(b,a)=>{const u=h("el-input"),f=h("el-form-item"),V=h("el-option"),$=h("el-select"),j=h("el-switch"),O=h("el-form"),t=h("el-button"),r=h("el-dialog");return U(),N(r,{title:g.value==="add"?"新增用户":"编辑用户",modelValue:v.value,"onUpdate:modelValue":a[7]||(a[7]=d=>v.value=d),width:"500px","close-on-click-modal":!1,onClose:S},{footer:s(()=>[B("span",Ie,[e(t,{onClick:S},{default:s(()=>a[8]||(a[8]=[y("取消")])),_:1}),e(t,{type:"primary",onClick:R,loading:x.value},{default:s(()=>a[9]||(a[9]=[y(" 确定 ")])),_:1},8,["loading"])])]),default:s(()=>[e(O,{ref_key:"formRef",ref:c,model:o,rules:q,"label-width":"100px",class:"user-form"},{default:s(()=>[e(f,{label:"用户名",prop:"username"},{default:s(()=>[e(u,{modelValue:o.username,"onUpdate:modelValue":a[0]||(a[0]=d=>o.username=d),placeholder:"请输入用户名",disabled:g.value==="edit"},null,8,["modelValue","disabled"])]),_:1}),e(f,{label:"真实姓名",prop:"realName"},{default:s(()=>[e(u,{modelValue:o.realName,"onUpdate:modelValue":a[1]||(a[1]=d=>o.realName=d),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),e(f,{label:"所属部门",prop:"departmentId"},{default:s(()=>[e($,{modelValue:o.departmentId,"onUpdate:modelValue":a[2]||(a[2]=d=>o.departmentId=d),placeholder:"请选择部门",class:"full-width"},{default:s(()=>[(U(!0),X(ee,null,Z(P.departments,d=>(U(),N(V,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"角色",prop:"role"},{default:s(()=>[e($,{modelValue:o.role,"onUpdate:modelValue":a[3]||(a[3]=d=>o.role=d),placeholder:"请选择角色",class:"full-width"},{default:s(()=>[e(V,{label:"管理员",value:"admin"}),e(V,{label:"录入员",value:"editor"}),e(V,{label:"查看员",value:"viewer"})]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"状态",prop:"status"},{default:s(()=>[e(j,{modelValue:o.status,"onUpdate:modelValue":a[4]||(a[4]=d=>o.status=d),"active-value":1,"inactive-value":0,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),g.value==="add"?(U(),N(f,{key:0,label:"密码",prop:"password"},{default:s(()=>[e(u,{modelValue:o.password,"onUpdate:modelValue":a[5]||(a[5]=d=>o.password=d),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1})):G("",!0),g.value==="add"?(U(),N(f,{key:1,label:"确认密码",prop:"confirmPassword"},{default:s(()=>[e(u,{modelValue:o.confirmPassword,"onUpdate:modelValue":a[6]||(a[6]=d=>o.confirmPassword=d),type:"password",placeholder:"请再次输入密码","show-password":""},null,8,["modelValue"])]),_:1})):G("",!0)]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])}}}),Ee=Y(Ne,[["__scopeId","data-v-2d215825"]]),Pe={class:"user-management-page"},Se={class:"control-container"},De={class:"action-buttons"},ze={class:"action-links"},Te=W({__name:"UserListView",setup(m){const p=_(!1),T=_([]),P=_(0),i=F({keyword:"",departmentId:void 0,role:void 0,status:void 0}),v=F({page:1,pageSize:20}),g=_([]),x=async()=>{try{const t=await te();g.value=t}catch(t){console.error("获取部门树失败:",t),w.error(t.message||"获取部门树失败")}},c=async()=>{p.value=!0;try{const t={...i,page:v.page,pageSize:v.pageSize},r=Object.entries(t).reduce((n,[C,A])=>(A!==void 0&&A!==""&&(n[C]=A),n),{}),d=await Ve(r);T.value=(d==null?void 0:d.list)||[],P.value=(d==null?void 0:d.total)||0}catch(t){console.error("获取用户列表失败:",t),w.error(t.message||"获取用户列表失败")}finally{p.value=!1}},o=()=>{v.page=1,c()},q=()=>{i.keyword="",i.departmentId=void 0,i.role=void 0,i.status=void 0,o()},M=t=>{v.pageSize=t,c()},S=t=>{v.page=t,c()},R=t=>({admin:"管理员",editor:"录入员",viewer:"查看员"})[t]||"未知",b=t=>{switch(t){case"admin":return"danger";case"editor":return"warning";case"viewer":return"info";default:return"info"}},a=t=>{if(!t)return"";try{return ye(_e(t),"yyyy-MM-dd HH:mm:ss")}catch(r){return console.error("日期格式化错误:",r),t}},u=async t=>{p.value=!0;try{await Ce(t.id,t.status),w.success("状态更新成功")}catch(r){w.error("状态更新失败: "+r.message),t.status=t.status===1?0:1}finally{p.value=!1}},f=t=>{Q.confirm(`确定要删除用户 "${t.realName}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{p.value=!0;try{await Ue(t.id),w.success("删除成功"),c()}catch(r){w.error("删除失败: "+r.message)}finally{p.value=!1}}).catch(()=>{w.info("已取消删除")})},V=_(),$=()=>{var t;(t=V.value)==null||t.open("add")},j=t=>{var r;(r=V.value)==null||r.open("edit",t)},O=t=>{Q.confirm(`确定要重置用户 "${t.realName}" 的密码吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{p.value=!0;try{await xe(t.id,{newPassword:"123456"}),w.success("密码已重置为默认密码 123456")}catch(r){w.error("密码重置失败: "+r.message)}finally{p.value=!1}}).catch(()=>{w.info("已取消重置密码")})};return ae(()=>{c(),x()}),(t,r)=>{const d=me("loading");return U(),X("div",Pe,[e(l(J),{class:"control-card",shadow:"never"},{default:s(()=>[B("div",Se,[e(l(le),{inline:!0,model:i,class:"search-form",onSubmit:re(o,["prevent"])},{default:s(()=>[e(l(D),{label:"关键字"},{default:s(()=>[e(l(se),{modelValue:i.keyword,"onUpdate:modelValue":r[0]||(r[0]=n=>i.keyword=n),placeholder:"用户名/姓名",clearable:""},null,8,["modelValue"])]),_:1}),e(l(D),{label:"部门"},{default:s(()=>[e(l(oe),{modelValue:i.departmentId,"onUpdate:modelValue":r[1]||(r[1]=n=>i.departmentId=n),data:g.value,props:{label:"name",children:"children",value:"id"},placeholder:"请选择部门",clearable:"",filterable:"","check-strictly":"","node-key":"id","default-expand-all":"",style:{width:"180px"}},null,8,["modelValue","data"])]),_:1}),e(l(D),{label:"角色"},{default:s(()=>[e(l(K),{modelValue:i.role,"onUpdate:modelValue":r[2]||(r[2]=n=>i.role=n),placeholder:"请选择角色",clearable:"",style:{width:"180px"}},{default:s(()=>[e(l(z),{label:"管理员",value:"admin"}),e(l(z),{label:"录入员",value:"editor"}),e(l(z),{label:"查看员",value:"viewer"})]),_:1},8,["modelValue"])]),_:1}),e(l(D),{label:"状态"},{default:s(()=>[e(l(K),{modelValue:i.status,"onUpdate:modelValue":r[3]||(r[3]=n=>i.status=n),placeholder:"请选择状态",clearable:"",style:{width:"180px"}},{default:s(()=>[e(l(z),{label:"启用",value:1}),e(l(z),{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),e(l(D),null,{default:s(()=>[e(l(I),{type:"primary",onClick:o,icon:l(ne)},{default:s(()=>r[6]||(r[6]=[y("搜索")])),_:1},8,["icon"]),e(l(I),{onClick:q,icon:l(de)},{default:s(()=>r[7]||(r[7]=[y("重置")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"]),B("div",De,[e(l(I),{type:"primary",onClick:$,icon:l(ue)},{default:s(()=>r[8]||(r[8]=[y("新增用户")])),_:1},8,["icon"])])])]),_:1}),e(l(J),{class:"table-card",shadow:"never"},{default:s(()=>[ie((U(),N(l(we),{data:T.value,style:{width:"100%"}},{default:s(()=>[e(l(k),{prop:"id",label:"ID",width:"80"}),e(l(k),{prop:"username",label:"用户名",width:"150"}),e(l(k),{prop:"realName",label:"真实姓名",width:"150"}),e(l(k),{prop:"role",label:"角色",width:"120"},{default:s(({row:n})=>[e(l(pe),{type:b(n.role)},{default:s(()=>[y(L(R(n.role)),1)]),_:2},1032,["type"])]),_:1}),e(l(k),{prop:"departmentName",label:"所属部门","min-width":"180","show-overflow-tooltip":""},{default:s(({row:n})=>[y(L(n.departmentName||"未分配"),1)]),_:1}),e(l(k),{prop:"status",label:"状态",width:"100"},{default:s(({row:n})=>[e(l(ce),{modelValue:n.status,"onUpdate:modelValue":C=>n.status=C,"active-value":1,"inactive-value":0,onChange:C=>u(n),"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(l(k),{prop:"createdAt",label:"创建时间",width:"180"},{default:s(({row:n})=>[y(L(a(n.createdAt)),1)]),_:1}),e(l(k),{label:"操作",fixed:"right",width:"220"},{default:s(({row:n})=>[B("div",ze,[e(l(I),{type:"primary",link:"",icon:l(fe),onClick:C=>j(n)},{default:s(()=>r[9]||(r[9]=[y("编辑")])),_:2},1032,["icon","onClick"]),e(l(I),{type:"danger",link:"",icon:l(ve),onClick:C=>f(n)},{default:s(()=>r[10]||(r[10]=[y("删除")])),_:2},1032,["icon","onClick"]),e(l(I),{type:"warning",link:"",icon:l(ge),onClick:C=>O(n)},{default:s(()=>r[11]||(r[11]=[y("重置密码")])),_:2},1032,["icon","onClick"])])]),_:1})]),_:1},8,["data"])),[[d,p.value]]),P.value>0?(U(),N(l(be),{key:0,class:"pagination-container",background:"",layout:"total, sizes, prev, pager, next, jumper",total:P.value,"current-page":v.page,"onUpdate:currentPage":r[4]||(r[4]=n=>v.page=n),"page-size":v.pageSize,"onUpdate:pageSize":r[5]||(r[5]=n=>v.pageSize=n),"page-sizes":[10,20,50,100],onSizeChange:M,onCurrentChange:S},null,8,["total","current-page","page-size"])):G("",!0)]),_:1}),e(Ee,{ref_key:"userDialogRef",ref:V,departments:g.value,onSuccess:c},null,8,["departments"])])}}}),Be=Y(Te,[["__scopeId","data-v-c47c5eb0"]]);export{Be as default};
