import{w as E,d as Y,r as y,l as F,p as I,g as s,h,n as A,i as U,f as e,v as G,e as J,G as Z,F as ee,j as B,k as _,E as w,_ as K,o as ae,u as t,Y as Q,L as le,s as te,$ as re,x as D,M as se,N as oe,a4 as W,a5 as T,C as N,O as ne,P as de,Q as ue,b as ie,c as me,a6 as k,a7 as pe,t as H,a8 as ce,T as fe,U as ve,a9 as ge,V as we,W as be,aa as _e,ab as ye,X}from"./index-BRnZ6Wrp.js";const Ve=m=>E.get("/users",{params:m}),he=m=>E.post("/users",m),ke=m=>E.put(`/users/${m.id}`,m),Ue=m=>E.delete(`/users/${m}`),Ce=(m,p)=>E.patch(`/users/${m}/status`,{status:p}),xe=(m,p)=>E.post(`/users/${m}/reset-password`,p),Ne={class:"dialog-footer"},Ie=Y({__name:"UserFormDialog",props:{departments:{}},emits:["success"],setup(m,{expose:p,emit:z}){const P=m,i=z,v=y(!1),g=y("add"),x=y(!1),c=y(),o=F({id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),M=F({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],realName:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],departmentId:[{required:!0,message:"请选择所属部门",trigger:"change"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],password:[{required:!0,message:"请输入密码",trigger:"blur",validator:(b,a,u)=>{var f;g.value==="add"&&!a?u(new Error("请输入密码")):(g.value==="add"&&o.confirmPassword&&((f=c.value)==null||f.validateField("confirmPassword")),u())}},{min:6,message:"密码长度不能小于 6 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:"blur",validator:(b,a,u)=>{g.value==="add"?a?a!==o.password?u(new Error("两次输入密码不一致")):u():u(new Error("请再次输入密码")):u()}}]}),R=(b,a)=>{g.value=b,v.value=!0,A(()=>{var u;(u=c.value)==null||u.clearValidate()}),b==="edit"&&a?Object.assign(o,{id:a.id,username:a.username,realName:a.realName,departmentId:a.departmentId,role:a.role,status:a.status,password:"",confirmPassword:""}):(Object.assign(o,{id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),A(()=>{var u,f;(u=c.value)==null||u.resetFields(["realName","departmentId","role","password","confirmPassword"]),g.value==="add"&&((f=c.value)==null||f.resetFields(["username"]))}))},S=()=>{v.value=!1,Object.assign(o,{id:void 0,username:"",realName:"",departmentId:void 0,role:"",status:1,password:"",confirmPassword:""}),A(()=>{var b;(b=c.value)==null||b.resetFields()})},q=async()=>{c.value&&await c.value.validate(async b=>{if(b){x.value=!0;try{if(g.value==="add"){const a={username:o.username,realName:o.realName,departmentId:o.departmentId,role:o.role,status:Number(o.status),password:o.password};console.log("提交的创建数据:",a),await he(a),w.success("创建成功")}else{if(!o.id){w.error("无法更新用户：用户ID丢失"),x.value=!1;return}const a={id:o.id,realName:o.realName,departmentId:o.departmentId,role:o.role,status:Number(o.status)};console.log("提交的更新数据:",a),await ke(a),w.success("更新成功")}i("success"),S()}catch(a){console.error("表单提交错误:",a),w.error(a.message||"操作失败")}finally{x.value=!1}}})};return p({open:R}),(b,a)=>{const u=h("el-input"),f=h("el-form-item"),V=h("el-option"),$=h("el-select"),O=h("el-switch"),j=h("el-form"),l=h("el-button"),r=h("el-dialog");return U(),I(r,{title:g.value==="add"?"新增用户":"编辑用户",modelValue:v.value,"onUpdate:modelValue":a[7]||(a[7]=d=>v.value=d),width:"500px","close-on-click-modal":!1,onClose:S},{footer:s(()=>[B("span",Ne,[e(l,{onClick:S},{default:s(()=>a[8]||(a[8]=[_("取消")])),_:1}),e(l,{type:"primary",onClick:q,loading:x.value},{default:s(()=>a[9]||(a[9]=[_(" 确定 ")])),_:1},8,["loading"])])]),default:s(()=>[e(j,{ref_key:"formRef",ref:c,model:o,rules:M,"label-width":"100px",class:"user-form"},{default:s(()=>[e(f,{label:"用户名",prop:"username"},{default:s(()=>[e(u,{modelValue:o.username,"onUpdate:modelValue":a[0]||(a[0]=d=>o.username=d),placeholder:"请输入用户名",disabled:g.value==="edit"},null,8,["modelValue","disabled"])]),_:1}),e(f,{label:"真实姓名",prop:"realName"},{default:s(()=>[e(u,{modelValue:o.realName,"onUpdate:modelValue":a[1]||(a[1]=d=>o.realName=d),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),e(f,{label:"所属部门",prop:"departmentId"},{default:s(()=>[e($,{modelValue:o.departmentId,"onUpdate:modelValue":a[2]||(a[2]=d=>o.departmentId=d),placeholder:"请选择部门",class:"full-width"},{default:s(()=>[(U(!0),J(ee,null,Z(P.departments,d=>(U(),I(V,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"角色",prop:"role"},{default:s(()=>[e($,{modelValue:o.role,"onUpdate:modelValue":a[3]||(a[3]=d=>o.role=d),placeholder:"请选择角色",class:"full-width"},{default:s(()=>[e(V,{label:"管理员",value:"admin"}),e(V,{label:"录入员",value:"editor"}),e(V,{label:"查看员",value:"viewer"})]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"状态",prop:"status"},{default:s(()=>[e(O,{modelValue:o.status,"onUpdate:modelValue":a[4]||(a[4]=d=>o.status=d),"active-value":1,"inactive-value":0,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),g.value==="add"?(U(),I(f,{key:0,label:"密码",prop:"password"},{default:s(()=>[e(u,{modelValue:o.password,"onUpdate:modelValue":a[5]||(a[5]=d=>o.password=d),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1})):G("",!0),g.value==="add"?(U(),I(f,{key:1,label:"确认密码",prop:"confirmPassword"},{default:s(()=>[e(u,{modelValue:o.confirmPassword,"onUpdate:modelValue":a[6]||(a[6]=d=>o.confirmPassword=d),type:"password",placeholder:"请再次输入密码","show-password":""},null,8,["modelValue"])]),_:1})):G("",!0)]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])}}}),Ee=K(Ie,[["__scopeId","data-v-2d215825"]]),Pe={class:"user-management-page"},Se={class:"control-container"},De={class:"action-buttons"},Te={class:"action-links"},ze=Y({__name:"UserListView",setup(m){const p=y(!1),z=y([]),P=y(0),i=F({keyword:"",departmentId:void 0,role:void 0,status:void 0}),v=F({page:1,pageSize:20}),g=y([]),x=async()=>{try{const l=await le();g.value=l}catch(l){console.error("获取部门树失败:",l),w.error(l.message||"获取部门树失败")}},c=async()=>{p.value=!0;try{const l={...i,page:v.page,pageSize:v.pageSize},r=Object.entries(l).reduce((n,[C,L])=>(L!==void 0&&L!==""&&(n[C]=L),n),{}),d=await Ve(r);z.value=(d==null?void 0:d.list)||[],P.value=(d==null?void 0:d.total)||0}catch(l){console.error("获取用户列表失败:",l),w.error(l.message||"获取用户列表失败")}finally{p.value=!1}},o=()=>{v.page=1,c()},M=()=>{i.keyword="",i.departmentId=void 0,i.role=void 0,i.status=void 0,o()},R=l=>{v.pageSize=l,c()},S=l=>{v.page=l,c()},q=l=>({admin:"管理员",editor:"录入员",viewer:"查看员"})[l]||"未知",b=l=>{switch(l){case"admin":return"danger";case"editor":return"warning";case"viewer":return"info";default:return"info"}},a=l=>{if(!l)return"";try{return _e(ye(l),"yyyy-MM-dd HH:mm:ss")}catch(r){return console.error("日期格式化错误:",r),l}},u=async l=>{p.value=!0;try{await Ce(l.id,l.status),w.success("状态更新成功")}catch(r){w.error("状态更新失败: "+r.message),l.status=l.status===1?0:1}finally{p.value=!1}},f=l=>{X.confirm(`确定要删除用户 "${l.realName}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{p.value=!0;try{await Ue(l.id),w.success("删除成功"),c()}catch(r){w.error("删除失败: "+r.message)}finally{p.value=!1}}).catch(()=>{w.info("已取消删除")})},V=y(),$=()=>{var l;(l=V.value)==null||l.open("add")},O=l=>{var r;(r=V.value)==null||r.open("edit",l)},j=l=>{X.confirm(`确定要重置用户 "${l.realName}" 的密码吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{p.value=!0;try{await xe(l.id,{newPassword:"123456"}),w.success("密码已重置为默认密码 123456")}catch(r){w.error("密码重置失败: "+r.message)}finally{p.value=!1}}).catch(()=>{w.info("已取消重置密码")})};return ae(()=>{c(),x()}),(l,r)=>{const d=me("loading");return U(),J("div",Pe,[e(t(Q),{class:"control-card",shadow:"never"},{default:s(()=>[B("div",Se,[e(t(te),{inline:!0,model:i,class:"search-form",onSubmit:re(o,["prevent"])},{default:s(()=>[e(t(D),{label:"关键字"},{default:s(()=>[e(t(se),{modelValue:i.keyword,"onUpdate:modelValue":r[0]||(r[0]=n=>i.keyword=n),placeholder:"用户名/姓名",clearable:""},null,8,["modelValue"])]),_:1}),e(t(D),{label:"部门"},{default:s(()=>[e(t(oe),{modelValue:i.departmentId,"onUpdate:modelValue":r[1]||(r[1]=n=>i.departmentId=n),data:g.value,props:{label:"name",children:"children",value:"id"},placeholder:"请选择部门",clearable:"",filterable:"","check-strictly":"","node-key":"id","default-expand-all":"",style:{width:"180px"}},null,8,["modelValue","data"])]),_:1}),e(t(D),{label:"角色"},{default:s(()=>[e(t(W),{modelValue:i.role,"onUpdate:modelValue":r[2]||(r[2]=n=>i.role=n),placeholder:"请选择角色",clearable:"",style:{width:"180px"}},{default:s(()=>[e(t(T),{label:"管理员",value:"admin"}),e(t(T),{label:"录入员",value:"editor"}),e(t(T),{label:"查看员",value:"viewer"})]),_:1},8,["modelValue"])]),_:1}),e(t(D),{label:"状态"},{default:s(()=>[e(t(W),{modelValue:i.status,"onUpdate:modelValue":r[3]||(r[3]=n=>i.status=n),placeholder:"请选择状态",clearable:"",style:{width:"180px"}},{default:s(()=>[e(t(T),{label:"启用",value:1}),e(t(T),{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),e(t(D),null,{default:s(()=>[e(t(N),{type:"primary",onClick:o,icon:t(ne)},{default:s(()=>r[6]||(r[6]=[_("搜索")])),_:1},8,["icon"]),e(t(N),{onClick:M,icon:t(de)},{default:s(()=>r[7]||(r[7]=[_("重置")])),_:1},8,["icon"])]),_:1})]),_:1},8,["model"]),B("div",De,[e(t(N),{type:"primary",onClick:$,icon:t(ue)},{default:s(()=>r[8]||(r[8]=[_("新增用户")])),_:1},8,["icon"])])])]),_:1}),e(t(Q),{class:"table-card",shadow:"never"},{default:s(()=>[ie((U(),I(t(we),{data:z.value,style:{width:"100%"}},{default:s(()=>[e(t(k),{prop:"id",label:"ID",width:"80"}),e(t(k),{prop:"username",label:"用户名",width:"150"}),e(t(k),{prop:"realName",label:"真实姓名",width:"150"}),e(t(k),{prop:"role",label:"角色",width:"120"},{default:s(({row:n})=>[e(t(pe),{type:b(n.role)},{default:s(()=>[_(H(q(n.role)),1)]),_:2},1032,["type"])]),_:1}),e(t(k),{prop:"departmentName",label:"所属部门","min-width":"180","show-overflow-tooltip":""},{default:s(({row:n})=>[_(H(n.departmentName||"未分配"),1)]),_:1}),e(t(k),{prop:"status",label:"状态",width:"100"},{default:s(({row:n})=>[e(t(ce),{modelValue:n.status,"onUpdate:modelValue":C=>n.status=C,"active-value":1,"inactive-value":0,onChange:C=>u(n),"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(t(k),{prop:"createdAt",label:"创建时间",width:"180"},{default:s(({row:n})=>[_(H(a(n.createdAt)),1)]),_:1}),e(t(k),{label:"操作",fixed:"right",width:"220"},{default:s(({row:n})=>[B("div",Te,[e(t(N),{type:"primary",link:"",icon:t(fe),onClick:C=>O(n)},{default:s(()=>r[9]||(r[9]=[_("编辑")])),_:2},1032,["icon","onClick"]),e(t(N),{type:"danger",link:"",icon:t(ve),onClick:C=>f(n)},{default:s(()=>r[10]||(r[10]=[_("删除")])),_:2},1032,["icon","onClick"]),e(t(N),{type:"warning",link:"",icon:t(ge),onClick:C=>j(n)},{default:s(()=>r[11]||(r[11]=[_("重置密码")])),_:2},1032,["icon","onClick"])])]),_:1})]),_:1},8,["data"])),[[d,p.value]]),P.value>0?(U(),I(t(be),{key:0,class:"pagination-container",background:"",layout:"total, sizes, prev, pager, next, jumper",total:P.value,"current-page":v.page,"onUpdate:currentPage":r[4]||(r[4]=n=>v.page=n),"page-size":v.pageSize,"onUpdate:pageSize":r[5]||(r[5]=n=>v.pageSize=n),"page-sizes":[10,20,50,100],onSizeChange:R,onCurrentChange:S},null,8,["total","current-page","page-size"])):G("",!0)]),_:1}),e(Ee,{ref_key:"userDialogRef",ref:V,departments:g.value,onSuccess:c},null,8,["departments"])])}}}),Be=K(ze,[["__scopeId","data-v-c47c5eb0"]]);export{Be as default};
